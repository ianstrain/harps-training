<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Training Schedule 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-section: #1a2234;
            --accent-primary: #00d4aa;
            --accent-secondary: #0ea5e9;
            --accent-warm: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2a3548;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(0, 212, 170, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(14, 165, 233, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px 16px 40px;
            position: relative;
            z-index: 1;
            overflow-x: hidden;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(0, 212, 170, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(14, 165, 233, 0.08) 0%, transparent 50%);
            z-index: 1000;
            padding: 12px 16px;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }

        .menu-toggle {
            position: fixed;
            top: 12px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        @media (max-width: 500px) {
            .menu-toggle {
                right: 12px;
                width: 36px;
                height: 36px;
            }
        }

        .menu-toggle:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
        }

        .menu-toggle span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .menu-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            max-width: 85vw;
            height: 100vh;
            background: var(--bg-dark);
            border-left: 2px solid var(--border-color);
            z-index: 1003;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
        }

        .menu-drawer.active {
            right: 0;
        }

        .menu-header {
            padding: 60px 20px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-section);
        }

        .menu-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .menu-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .menu-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .menu-section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab-content {
            display: none;
            padding-bottom: 40px;
        }

        .tab-content.active {
            display: block;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            margin-top: 60px; /* Space for fixed tabs */
            padding: 24px 0;
        }

        .header-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-dark);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding: 6px 14px;
            border-radius: 20px;
            margin-bottom: 16px;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .edit-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--bg-section);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .edit-toggle label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .toggle-switch input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
            margin: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .toggle-slider::before {
            position: absolute;
            content: '';
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(16px);
            background: var(--bg-dark);
        }

        .edit-status {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--bg-section);
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .edit-status.active {
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent-primary);
        }

        .edit-controls {
            display: none;
        }

        .view-toggles {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .edit-toggle,
        .view-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px;
            background: var(--bg-section);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .cleanup-btn {
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cleanup-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .players-controls {
            display: none;
        }

        .add-player-btn {
            padding: 12px 16px;
            background: rgba(0, 212, 170, 0.1);
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            color: var(--accent-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-player-btn:hover {
            background: rgba(0, 212, 170, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        .add-session-btn-bottom {
            padding: 12px 16px;
            background: rgba(0, 212, 170, 0.1);
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            color: var(--accent-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-session-btn-bottom:hover {
            background: rgba(0, 212, 170, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        .delete-player-btn {
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 4px;
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }

        .delete-player-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .player-card.deleted {
            opacity: 0.6;
            border-color: var(--text-muted);
            background: linear-gradient(135deg, var(--bg-section) 0%, rgba(239, 68, 68, 0.05) 100%);
            position: relative;
        }

        .player-card.deleted::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--danger);
        }

        .deleted-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
        }

        .player-name-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .player-name {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        #players-tab {
            padding-bottom: 100px;
        }

        .new-session-card {
            border: 2px dashed var(--border-color);
            background: var(--bg-section);
        }

        .new-session-date-input,
        .new-session-location-input,
        .new-session-time-input {
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .new-session-date-input:focus,
        .new-session-location-input:focus,
        .new-session-time-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .new-session-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
        }

        .save-session-btn,
        .cancel-session-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .save-session-btn {
            background: var(--accent-primary);
            border: 2px solid var(--accent-primary);
            color: var(--bg-dark);
        }

        .save-session-btn:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        .cancel-session-btn {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .cancel-session-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .new-player-card {
            border: 2px dashed var(--border-color);
            background: var(--bg-section);
        }

        .player-name-input,
        .player-jersey-input,
        .player-parent-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .player-name-input {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .player-name-input:focus,
        .player-jersey-input:focus,
        .player-parent-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .new-player-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .save-player-btn,
        .cancel-player-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .save-player-btn {
            background: var(--accent-primary);
            border: 2px solid var(--accent-primary);
            color: var(--bg-dark);
        }

        .save-player-btn:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        .cancel-player-btn {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .cancel-player-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .view-toggle label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            white-space: nowrap;
        }

        .edit-toggle label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            white-space: nowrap;
        }

        .edit-toggle label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }

        .session-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .session-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 30px rgba(0, 212, 170, 0.1);
        }

        /* Match card specific styling */
        .session-card.match-card {
            border-left: 4px solid var(--accent-secondary);
            position: relative;
            cursor: pointer;
        }

        .session-card.match-card:hover {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.1);
        }

        .session-card.match-card.flipped .session-card-front {
            display: none;
        }

        .session-card.match-card.flipped .session-card-back {
            display: block;
        }

        .session-card-front,
        .session-card-back {
            width: 100%;
        }

        .session-card-back {
            display: none;
        }

        .match-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .match-type-badge.friendly {
            background: rgba(14, 165, 233, 0.15);
            color: var(--accent-secondary);
        }

        .match-type-badge.league {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .match-type-badge.cup {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warm);
        }

        .opponent-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 8px 0 12px 0;
            padding: 0 20px;
        }

        .cup-stage {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 0 20px;
        }

        .match-card .session-meta {
            padding: 0 20px 10px 20px;
        }

        .match-card .match-input-group {
            padding: 0 20px;
        }

        /* Match card back - attendance tracking */
        .attendance-section {
            padding: 20px;
        }

        .attendance-section-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .attendance-checklist {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 8px;
            background: var(--bg-section);
            border-radius: 8px;
        }

        .attendance-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 8px 12px 8px;
            margin-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .attendance-header-label {
            width: 20px;
            flex-shrink: 0;
            text-align: center;
            font-size: 9px;
            line-height: 1.2;
        }

        .attendance-header-player {
            flex: 1;
            font-size: 11px;
        }

        .attendance-header-captain {
            width: auto;
            min-width: 60px;
            flex-shrink: 0;
            text-align: center;
            font-size: 10px;
            line-height: 1.2;
            color: var(--accent-warm);
        }

        .attendance-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .attendance-item:hover {
            background: var(--bg-card);
        }

        .attendance-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
        }

        .attendance-player-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .captain-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-warm);
            flex-shrink: 0;
            position: relative;
        }

        .captain-checkbox:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .captain-checkbox:checked {
            accent-color: var(--accent-warm);
        }

        .captain-section {
            margin-bottom: 20px;
        }

        .captain-selector {
            width: 100%;
            padding: 12px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .captain-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .goal-scorers-section {
            margin-bottom: 20px;
        }

        .goal-scorer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: var(--bg-section);
            border-radius: 8px;
        }

        .goal-scorer-name {
            font-size: 14px;
            color: var(--text-primary);
            flex: 1;
        }

        .goal-scorer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .goal-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .goal-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: var(--bg-dark);
        }

        .goal-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .goal-count {
            min-width: 32px;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .save-match-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .save-match-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        /* Session type selector for new sessions/matches */
        .session-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-section);
            border-radius: 8px;
        }

        .type-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .type-option:hover {
            border-color: var(--accent-primary);
        }

        .type-option.selected {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent-primary);
        }

        .match-fields {
            display: none;
        }

        .match-fields.active {
            display: block;
        }

        .match-input-group {
            margin-bottom: 12px;
        }

        .match-input-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .match-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .match-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .match-type-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .match-type-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Attendance chart in Stats tab */
        .attendance-chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 20px;
        }

        .attendance-chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .attendance-chart-svg-container {
            width: 100%;
            height: 400px;
            overflow: visible;
        }

        .attendance-bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .attendance-bar:hover {
            opacity: 0.8;
        }

        .attendance-bar.high {
            fill: var(--success);
        }

        .attendance-bar.medium {
            fill: var(--accent-warm);
        }

        .attendance-bar.low {
            fill: var(--accent-secondary);
        }

        .attendance-player-label {
            font-size: 12px;
            fill: var(--text-secondary);
            text-anchor: middle;
        }

        .attendance-value-label {
            font-size: 14px;
            fill: var(--text-primary);
            font-weight: 600;
            text-anchor: middle;
        }

        .captain-star {
            fill: var(--accent-warm);
            stroke: var(--bg-dark);
            stroke-width: 0.5;
        }

        .session-card.cancelled {
            opacity: 0.7;
            border-color: var(--danger);
        }

        .session-card.cancelled:hover {
            border-color: var(--danger);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.1);
        }

        .session-card.cancelled .session-number {
            color: var(--danger);
        }

        .session-card.deleted {
            opacity: 0.5;
            border-color: var(--text-muted);
            background: var(--bg-section);
        }

        .session-card.deleted .session-number::after {
            content: ' (Deleted)';
            font-size: 0.5em;
            color: var(--text-muted);
        }

        .delete-session-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            margin-top: 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            width: 100%;
            justify-content: center;
        }

        .delete-session-btn:hover {
            background: #ef4444;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .delete-icon {
            font-size: 16px;
        }

        .add-session-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .add-session-form {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .new-session-date-input {
            padding: 12px 16px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .new-session-date-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .add-session-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .add-session-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 170, 0.05);
            color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.2);
        }

        .add-session-icon {
            font-size: 24px;
            font-weight: 300;
            line-height: 1;
        }

        .add-session-text {
            font-size: 16px;
        }

        .cancelled-notice {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            text-align: center;
            gap: 12px;
        }

        .cancelled-badge {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 8px 16px;
            border-radius: 20px;
        }

        .cancelled-reason {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .session-cancel-controls {
            margin-top: 16px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--bg-section);
        }

        .cancel-toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .cancel-toggle-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .cancel-toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .cancel-toggle-switch input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
            margin: 0;
        }

        .cancel-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 28px;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .cancel-toggle-slider::before {
            position: absolute;
            content: '';
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .cancel-toggle-switch input:checked + .cancel-toggle-slider {
            background: #ef4444;
            border-color: #ef4444;
        }

        .cancel-toggle-switch input:checked + .cancel-toggle-slider::before {
            transform: translateX(24px);
            background: var(--bg-dark);
        }

        .cancel-reason-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .cancel-reason-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .cancel-reason-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .session-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .session-date-edit {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .session-date-edit label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .session-date-input {
            flex: 1;
            padding: 10px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .session-date-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .meta-item-edit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .meta-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .session-number {
            position: absolute;
            top: 16px;
            right: 16px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--border-color);
            line-height: 1;
        }

        .session-date {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .session-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .meta-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .session-description {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border-color);
        }

        .session-description .activity-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .session-description .activity-input {
            min-height: 60px;
        }

        .session-activities {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-block {
            background: var(--bg-section);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .activity-block.warmup { border-left-color: var(--accent-warm); }
        .activity-block.drills { border-left-color: var(--accent-secondary); }
        .activity-block.match { border-left-color: var(--accent-primary); }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .activity-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .warmup .activity-title { color: var(--accent-warm); }
        .drills .activity-title { color: var(--accent-secondary); }
        .match .activity-title { color: var(--accent-primary); }

        .activity-duration {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .activity-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .activity-content.placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .video-embed {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-dark);
        }

        .video-embed iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .activity-input {
            width: 100%;
            min-height: 60px;
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            resize: vertical;
            transition: all 0.3s ease;
        }

        .activity-input:focus {
            outline: none;
            border-style: solid;
        }

        .warmup .activity-input:focus { border-color: var(--accent-warm); }
        .drills .activity-input:focus { border-color: var(--accent-secondary); }
        .match .activity-input:focus { border-color: var(--accent-primary); }

        .activity-input::placeholder { color: var(--text-muted); }

        .hidden { display: none !important; }

        .save-indicator {
            position: fixed;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: var(--bg-dark);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
        }

        .save-indicator.show { 
            opacity: 1;
            visibility: visible;
        }

        footer {
            text-align: center;
            padding: 32px 0 80px;
            color: var(--text-muted);
            font-size: 12px;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .session-card {
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }

        .session-card:nth-child(1) { animation-delay: 0.1s; }
        .session-card:nth-child(2) { animation-delay: 0.15s; }
        .session-card:nth-child(3) { animation-delay: 0.2s; }
        .session-card:nth-child(4) { animation-delay: 0.25s; }
        .session-card:nth-child(5) { animation-delay: 0.3s; }
        .session-card:nth-child(6) { animation-delay: 0.35s; }
        .session-card:nth-child(7) { animation-delay: 0.4s; }
        .session-card:nth-child(8) { animation-delay: 0.45s; }

        .players-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .player-card-wrapper {
            position: relative;
            transition: height 0.6s ease;
            margin-bottom: 16px;
            width: 100%;
            max-width: 100%;
            overflow: visible;
        }

        .player-card {
            position: relative;
            width: 100%;
            max-width: 100%;
            cursor: pointer;
            min-height: 150px;
            overflow: hidden;
        }

        .player-card-front,
        .player-card-back {
            width: 100%;
            max-width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 20px;
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-sizing: border-box;
            overflow: hidden;
        }

        .player-card-front {
            position: relative;
            z-index: 2;
        }

        .player-card-front:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 30px rgba(0, 212, 170, 0.1);
        }

        .player-card-back {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            z-index: 1;
        }

        .player-card.flipped .player-card-front {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            z-index: 1;
        }

        .player-card.flipped .player-card-back {
            position: relative;
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            z-index: 2;
        }

        .player-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .jersey-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            background: var(--bg-section);
            padding: 4px 12px;
            border-radius: 8px;
            border: 2px solid var(--accent-primary);
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
            line-height: 1;
        }

        .jersey-icon {
            font-size: 20px;
            display: inline-block;
            line-height: 1;
            filter: hue-rotate(120deg) saturate(2) brightness(0.6);
            margin-bottom: -2px;
        }

        .player-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .player-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .player-statistics {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-value {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .recent-goals {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }

        .recent-goals-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .recent-goal-item {
            font-size: 11px;
            color: var(--text-secondary);
            padding-left: 8px;
        }

        .notes-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .notes-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.1);
        }

        .save-notes-btn {
            padding: 8px 16px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            align-self: flex-start;
        }

        .save-notes-btn:hover {
            background: var(--accent-secondary);
        }

        .save-notes-btn:active {
            transform: scale(0.98);
        }

        .player-detail-label {
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 100px;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
        }

        .player-detail-value {
            color: var(--text-primary);
            flex: 1;
        }

        .goal-log-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .total-goals {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-section);
            border-radius: 8px;
        }

        .total-goals-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .goal-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .goal-date-input,
        .goal-count-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-section);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }

        .goal-count-input {
            flex: 0 0 80px;
            text-align: center;
            min-width: 80px;
        }

        .goal-date-input:focus,
        .goal-count-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        /* Prevent iOS zoom on input focus */
        @supports (-webkit-touch-callout: none) {
            .goal-date-input,
            .goal-count-input {
                font-size: 16px;
            }
        }

        .add-goal-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .add-goal-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        .goals-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-section);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .goal-date {
            color: var(--text-secondary);
        }

        .delete-goal-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            transition: all 0.3s ease;
        }

        .delete-goal-btn:hover {
            color: #ef4444;
        }

        .no-goals {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            padding: 20px;
            font-style: italic;
        }

        .goals-chart {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .goals-chart-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .goals-chart-container {
            width: 100%;
            height: 110px;
            position: relative;
            overflow: visible;
        }

        .goals-chart-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .goals-chart-bar {
            fill: var(--accent-primary);
            transition: all 0.3s ease;
        }

        .goals-chart-bar:hover {
            fill: var(--accent-secondary);
            opacity: 0.9;
        }


        .goals-chart-label {
            font-size: 10px;
            fill: var(--text-secondary);
            text-anchor: middle;
            font-weight: 500;
        }

        .goals-chart-label-letter {
            font-size: 9px;
            fill: var(--text-secondary);
            text-anchor: middle;
            font-weight: 400;
        }

        .goals-chart-label-rotated {
            font-size: 5px;
            fill: var(--text-secondary);
            text-anchor: middle;
            font-weight: 900;
            letter-spacing: 6px;
        }

        .goals-chart-value {
            font-size: 8px;
            fill: var(--accent-primary);
            text-anchor: middle;
            font-weight: 500;
        }

        .players-header,
        .thisweek-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .players-header h2,
        .thisweek-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stats-chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 20px;
        }

        .stats-chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-chart-svg-container {
            width: 100%;
            height: 300px;
            overflow: visible;
        }

        .stats-chart-bar {
            fill: var(--accent-primary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stats-chart-bar:hover {
            fill: var(--accent-secondary);
            opacity: 0.9;
        }

        .stats-chart-player-label {
            font-size: 28px;
            fill: var(--text-secondary);
            text-anchor: middle;
            font-weight: 500;
            dominant-baseline: middle;
        }

        .stats-chart-goal-value {
            font-size: 24px;
            fill: var(--accent-primary);
            text-anchor: middle;
            font-weight: 700;
        }

        .stats-chart-axis-label {
            font-size: 24px;
            fill: var(--text-secondary);
            font-weight: 600;
        }

        .stats-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .stats-empty p {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .stats-empty small {
            font-size: 14px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .edit-controls,
            .players-controls {
                padding: 4px 6px;
                gap: 3px;
            }

            .edit-toggle,
            .view-toggle {
                padding: 3px 6px;
                gap: 4px;
            }

            .edit-toggle label,
            .view-toggle label {
                font-size: 9px;
            }

            .toggle-switch {
                width: 32px;
                height: 18px;
            }

            .toggle-slider {
                border-radius: 18px;
            }

            .toggle-slider::before {
                height: 12px;
                width: 12px;
            }

            .toggle-switch input:checked + .toggle-slider::before {
                transform: translateX(14px);
            }

            .cleanup-btn,
            .add-player-btn,
            .add-session-btn-bottom {
                padding: 3px 6px;
                font-size: 9px;
            }

            .tab-content {
                padding-bottom: 50px;
            }

            #players-tab {
                padding-bottom: 50px;
            }

            .goal-input-group {
                flex-direction: column;
                gap: 8px;
                width: 100%;
                max-width: 100%;
            }
            
            .goal-count-input {
                flex: 1;
                min-width: auto;
                width: 100%;
                max-width: 100%;
            }
            
            .goal-date-input {
                width: 100%;
                max-width: 100%;
            }
            
            .player-card-front,
            .player-card-back {
                padding: 16px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .goal-log-title {
                font-size: 16px;
            }
            
            .total-goals {
                font-size: 20px;
                padding: 10px;
            }
            
            .goals-chart-container {
                height: 110px;
            }
            
            .goals-chart-label,
            .goals-chart-label-letter,
            .goals-chart-label-rotated {
                font-size: 5px;
            }
            
            .stats-chart-container {
                padding: 16px;
            }
            
            .stats-chart-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .stats-chart-svg-container {
                height: 500px;
            }
            
            .stats-chart-player-label {
                font-size: 24px;
            }
            
            .stats-chart-goal-value {
                font-size: 20px;
            }
            
            .stats-chart-axis-label {
                font-size: 20px;
            }
            
            .goals-chart-value {
                font-size: 7px;
            }
            
            .container {
                max-width: 100%;
                padding: 20px 12px 40px;
            }
        }

        @media (max-width: 380px) {
            h1 { font-size: 2.4rem; }
            .session-number { font-size: 2rem; }
            .player-card-front,
            .player-card-back { padding: 12px; }
            .player-name { font-size: 18px; }
            .player-detail-item { font-size: 13px; }
            .stat-item { font-size: 12px; }
            .recent-goal-item { font-size: 10px; }
            .notes-textarea {
                min-height: 60px;
                font-size: 13px;
            }
            .save-notes-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
            .goal-input-group {
                gap: 8px;
            }
            .goal-date-input,
            .goal-count-input {
                padding: 10px;
                font-size: 13px;
            }
            .add-goal-btn {
                padding: 10px;
                font-size: 13px;
            }
            .goals-chart-container {
                height: 100px;
            }
            .goals-chart-title {
                font-size: 10px;
                margin-bottom: 8px;
            }
            .goals-chart-label,
            .goals-chart-label-letter,
            .goals-chart-label-rotated {
                font-size: 5px;
            }
            .goals-chart-value {
                font-size: 6px;
            }
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .calendar-nav-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-size: 32px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            font-weight: 300;
        }

        .calendar-nav-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: scale(1.1);
        }

        #calendarTitle {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-secondary);
            padding: 12px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calendar-day {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            min-height: 100px;
            height: 120px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .calendar-day:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.1);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.2);
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            overflow-y: auto;
        }

        .calendar-event {
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-event:hover {
            transform: translateX(2px);
        }

        .calendar-event.training {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }

        .calendar-event.match {
            background: rgba(255, 170, 0, 0.2);
            color: var(--accent-warm);
            border-left: 3px solid var(--accent-warm);
        }

        .calendar-event.cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            text-decoration: line-through;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .calendar {
                gap: 4px;
                padding: 10px;
            }

            .calendar-day {
                min-height: 70px;
                height: 80px;
                padding: 4px;
            }

            .calendar-day-number {
                font-size: 12px;
            }

            .calendar-event {
                font-size: 8px;
                padding: 2px 4px;
            }

            .calendar-header {
                padding: 0 10px;
                margin-bottom: 20px;
            }

            .calendar-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }

            #calendarTitle {
                font-size: 2rem;
            }

            .calendar-day-header {
                font-size: 11px;
                padding: 8px 0;
            }
        }

        @media (max-width: 480px) {
            .calendar-day {
                min-height: 60px;
                height: 70px;
                padding: 3px;
            }

            .calendar-day-number {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .calendar-event {
                font-size: 7px;
                padding: 1px 2px;
            }

            .calendar-day-header {
                font-size: 9px;
                padding: 6px 0;
            }

            #calendarTitle {
                font-size: 1.5rem;
            }

            .calendar-nav-btn {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>BALLYRAINE HARPS SCHEDULE</h1>
        </header>

        <nav class="tabs">
            <button class="tab-button active" data-tab="schedule">Schedule</button>
            <button class="tab-button" data-tab="calendar">Calendar</button>
            <button class="tab-button" data-tab="players">Players</button>
        </nav>
        <button class="menu-toggle" id="menuToggle" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
        <div class="menu-drawer" id="menuDrawer">
            <div class="menu-header">
                <h3 id="menuTitle">Options</h3>
            </div>
            <div class="menu-content" id="menuContent">
                <!-- Menu content will be populated by JavaScript -->
            </div>
        </div>

        <div class="tab-content" id="thisweek-tab">
            <div class="thisweek-header">
                <h2>THIS WEEK</h2>
            </div>
            <div id="thisweek-container"></div>
        </div>

        <div class="tab-content active" id="schedule-tab">
            <main id="sessions"></main>

        </div>

        <div class="tab-content" id="calendar-tab">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prevMonth" onclick="changeMonth(-1)"></button>
                <h2 id="calendarTitle">CALENDAR</h2>
                <button class="calendar-nav-btn" id="nextMonth" onclick="changeMonth(1)"></button>
            </div>
            <div id="calendar-container"></div>
        </div>

        <div class="tab-content" id="players-tab">
            <div class="players-header">
                <h2>PLAYER INFORMATION</h2>
            </div>
            <div class="players-container" id="players-container">
            </div>
        </div>

        <div class="tab-content" id="stats-tab">
            <div class="players-header">
                <h2>GOALS STATISTICS</h2>
            </div>
            <div id="stats-container">
            </div>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        <span></span> Synced!
    </div>

    <script>
        // SCRIPT_URL removed - now using Firebase database instead
        
        // ============================================
        // FIREBASE CONFIGURATION - UPDATE THIS SECTION
        // ============================================
        // To set up Firebase:
        // 1. Go to https://console.firebase.google.com
        // 2. Create a new project (or use existing)
        // 3. Enable Realtime Database
        // 4. Go to Project Settings > Your apps > Web app
        // 5. Copy the config object and replace the values below
        // ============================================
        const firebaseConfig = {
        apiKey: "AIzaSyDxnXltlxrvj7XaplM21IJqvW-7SPI0C60",
        authDomain: "ballyraine-harps.firebaseapp.com",
        databaseURL: "https://ballyraine-harps-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "ballyraine-harps",
        storageBucket: "ballyraine-harps.firebasestorage.app",
        messagingSenderId: "150301654173",
        appId: "1:150301654173:web:3dfc661d09a5421e5f2874",
        measurementId: "G-W9P5F8E1X3"
        };
        // ============================================
        
        // Initialize Firebase (only if config is provided and Firebase is loaded)
        let database = null;
        if (typeof firebase !== 'undefined' && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized');
            } catch (e) {
                console.error('Failed to initialize Firebase:', e);
                console.log('Using localStorage only');
            }
        } else {
            if (typeof firebase === 'undefined') {
                console.warn('Firebase scripts not loaded - check internet connection. Using localStorage only.');
        } else {
            console.log('Firebase not configured - using localStorage only');
            }
        }

        // Sessions array - loaded from Firebase
        let sessions = [];

        const defaults = {
            desc: 'Add a description for this session...',
            warmup: 'General warm-up & stretching',
            drills: 'Tap edit mode to add drills...',
            game: 'Full game play',
            // Match defaults
            opponent: 'Enter opponent team name',
            matchType: 'friendly',
            cupStage: '',
            teamScore: '',
            opponentScore: '',
            result: '' // 'win', 'draw', 'loss', or ''
        };

        let editMode = false;
        let showPastSessions = false;
        let showDeletedSessions = false;
        let showDeletedPlayers = false;
        let showTraining = true;
        let showMatches = true;
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        function formatDate(date) {
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            const formatted = date.toLocaleDateString('en-IE', options);
            const day = date.getDate();
            const suffix = day > 3 && day < 21 ? 'th' : ['th','st','nd','rd','th','th','th','th','th','th'][day % 10];
            return formatted.replace(day, day + suffix);
        }

        // Convert YouTube URLs to embedded videos
        function parseContent(text) {
            if (!text) return text;
            
            // YouTube URL patterns (including Shorts)
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})(?:\S*)?/g;
            
            // Replace YouTube URLs with embedded players
            const parsed = text.replace(youtubeRegex, function(match, videoId) {
                return '<div class="video-embed"><iframe src="https://www.youtube.com/embed/' + videoId + '" allowfullscreen></iframe></div>';
            });
            
            return parsed;
        }

        async function loadSessionsFromFirebase() {
            if (!database) {
                console.log('Firebase not configured - using empty sessions array');
                return;
            }
            
            try {
                const sessionsListRef = database.ref('sessionsList');
                const snapshot = await sessionsListRef.once('value');
                const sessionsListData = snapshot.val();
                
                if (sessionsListData) {
                    // Convert Firebase object to array and parse dates
                    sessions = Object.values(sessionsListData).map(s => ({
                        ...s,
                        date: s.date ? new Date(s.date) : new Date(),
                        location: s.location || 'The Aura',
                        time: s.time || '7:30 PM - 8:30 PM',
                        deleted: s.deleted || false,
                        // Match-specific fields
                        type: s.type || 'training',
                        opponent: s.opponent || '',
                        matchType: s.matchType || 'friendly',
                        cupStage: s.cupStage || '',
                        attendance: s.attendance || [],
                        captain: s.captain || '',
                        matchGoals: s.matchGoals || {}
                    })).sort((a, b) => a.id - b.id);
                    console.log('Sessions structure loaded from Firebase:', sessions.length);
                } else {
                    console.log('No sessions structure found in Firebase');
                    sessions = [];
                }
            } catch (e) {
                console.error('Failed to load sessions structure from Firebase:', e);
                sessions = [];
            }
        }

        async function loadData() {
            // First load sessions structure if not already loaded
            if (sessions.length === 0) {
                await loadSessionsFromFirebase();
            }
            
            // If still no sessions, use fallback
            if (sessions.length === 0) {
                console.log('No sessions found, using fallback');
                return;
            }
            
            // Try to load session content from Firebase
            if (database) {
                try {
                    const sessionsRef = database.ref('sessions');
                    const snapshot = await sessionsRef.once('value');
                    const firebaseData = snapshot.val();
                    
                    if (firebaseData) {
                        // Load data from Firebase
                        sessions.forEach(s => {
                            const sessionData = firebaseData[s.id];
                            if (sessionData) {
                                // Training session fields
                                s.desc = sessionData.desc || '';
                                s.warmup = sessionData.warmup || '';
                                s.drills = sessionData.drills || '';
                                s.game = sessionData.game || '';
                                // Match session fields
                                s.attendance = sessionData.attendance || [];
                                s.captain = sessionData.captain || '';
                                s.matchGoals = sessionData.matchGoals || {};
                                // Match score fields
                                s.teamScore = sessionData.teamScore || '';
                                s.opponentScore = sessionData.opponentScore || '';
                                s.result = sessionData.result || '';
                            }
                        });
                        // Cache in localStorage
                        const data = {};
                        sessions.forEach(s => {
                            data[s.id + '_desc'] = s.desc;
                            data[s.id + '_warmup'] = s.warmup;
                            data[s.id + '_drills'] = s.drills;
                            data[s.id + '_game'] = s.game;
                            data[s.id + '_attendance'] = JSON.stringify(s.attendance || []);
                            data[s.id + '_captain'] = s.captain || '';
                            data[s.id + '_matchGoals'] = JSON.stringify(s.matchGoals || {});
                            data[s.id + '_teamScore'] = s.teamScore || '';
                            data[s.id + '_opponentScore'] = s.opponentScore || '';
                            data[s.id + '_result'] = s.result || '';
                        });
                        localStorage.setItem('trainingData', JSON.stringify(data));
                        renderSessions();
                        return;
                    }
                } catch (e) {
                    console.error('Failed to load from Firebase:', e);
                }
            }
            
            // Fallback to localStorage cache
            const cached = localStorage.getItem('trainingData');
            if (cached) {
                const data = JSON.parse(cached);
                sessions.forEach(s => {
                    s.desc = data[s.id + '_desc'] || '';
                    s.warmup = data[s.id + '_warmup'] || '';
                    s.drills = data[s.id + '_drills'] || '';
                    s.game = data[s.id + '_game'] || '';
                    s.attendance = data[s.id + '_attendance'] ? JSON.parse(data[s.id + '_attendance']) : [];
                    s.captain = data[s.id + '_captain'] || '';
                    s.matchGoals = data[s.id + '_matchGoals'] ? JSON.parse(data[s.id + '_matchGoals']) : {};
                    s.teamScore = data[s.id + '_teamScore'] || '';
                    s.opponentScore = data[s.id + '_opponentScore'] || '';
                    s.result = data[s.id + '_result'] || '';
                });
                renderSessions();
            }
        }

        async function saveSessionsList() {
            if (!database) {
                return;
            }
            
            try {
                const sessionsListRef = database.ref('sessionsList');
                const sessionsListData = {};
                
                sessions.forEach(s => {
                    sessionsListData[s.id] = {
                        id: s.id,
                        date: s.date ? s.date.toISOString() : new Date().toISOString(),
                        cancelled: s.cancelled || false,
                        cancelReason: s.cancelReason || '',
                        location: s.location || 'The Aura',
                        time: s.time || '7:30 PM - 8:30 PM',
                        deleted: s.deleted || false,
                        // Match-specific fields
                        type: s.type || 'training',
                        opponent: s.opponent || '',
                        matchType: s.matchType || 'friendly',
                        cupStage: s.cupStage || ''
                    };
                });
                
                await sessionsListRef.set(sessionsListData);
                console.log('Sessions list saved to Firebase');
            } catch (e) {
                console.error('Failed to save sessions list to Firebase:', e);
            }
        }

        async function saveData() {
            const data = {};
            sessions.forEach(s => {
                data[s.id + '_desc'] = s.desc;
                data[s.id + '_warmup'] = s.warmup;
                data[s.id + '_drills'] = s.drills;
                data[s.id + '_game'] = s.game;
                data[s.id + '_attendance'] = JSON.stringify(s.attendance || []);
                data[s.id + '_captain'] = s.captain || '';
                data[s.id + '_matchGoals'] = JSON.stringify(s.matchGoals || {});
                data[s.id + '_teamScore'] = s.teamScore || '';
                data[s.id + '_opponentScore'] = s.opponentScore || '';
                data[s.id + '_result'] = s.result || '';
            });
            
            // Save to localStorage
            localStorage.setItem('trainingData', JSON.stringify(data));
            
            // Save to Firebase
            if (database) {
                try {
                    const sessionsRef = database.ref('sessions');
                    const sessionsData = {};
                    
                    sessions.forEach(s => {
                        sessionsData[s.id] = {
                            id: s.id,
                            desc: s.desc || '',
                            warmup: s.warmup || '',
                            drills: s.drills || '',
                            game: s.game || '',
                            // Match-specific fields
                            attendance: s.attendance || [],
                            captain: s.captain || '',
                            matchGoals: s.matchGoals || {},
                            teamScore: s.teamScore || '',
                            opponentScore: s.opponentScore || '',
                            result: s.result || '',
                            lastUpdated: new Date().toISOString()
                        };
                    });
                    
                    await sessionsRef.set(sessionsData);
                    console.log('Data saved to Firebase');
                } catch (e) {
                    console.error('Failed to save to Firebase:', e);
                    console.log('Data saved locally only');
                }
            }
            
            showSaveIndicator();
        }

        let saveTimeout = null;
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            // Clear any existing timeout
            if (saveTimeout) clearTimeout(saveTimeout);
            // Show the indicator
            indicator.classList.add('show');
            // Hide after 2 seconds
            saveTimeout = setTimeout(function() {
                indicator.classList.remove('show');
            }, 2000);
        }

        function generateSessionCard(session) {
            // If it's a new session, show an editable card
            if (session._isNew) {
                const tempId = session._tempId || '';
                const defaultDateStr = session.date ? new Date(session.date).toISOString().split('T')[0] : '';
                const sessionType = session.type || 'training';
                
                return `
                    <article class="session-card new-session-card" data-temp-id="${tempId}">
                        <div class="session-header">
                            <span class="session-number">New</span>
                            <div class="session-type-selector">
                                <div class="type-option ${sessionType === 'training' ? 'selected' : ''}" data-type="training" onclick="selectSessionType('${tempId}', 'training')">Training</div>
                                <div class="type-option ${sessionType === 'match' ? 'selected' : ''}" data-type="match" onclick="selectSessionType('${tempId}', 'match')">Match</div>
                            </div>
                            <div class="session-date-edit">
                                <label>Date:</label>
                                <input type="date" class="new-session-date-input" value="${defaultDateStr}" />
                            </div>
                        </div>
                        <div class="session-meta">
                            <div class="meta-item meta-item-edit">
                                <span class="meta-icon"></span>
                                <input type="text" class="new-session-location-input" value="${session.location || 'The Aura'}" placeholder="Location" />
                            </div>
                            <div class="meta-item meta-item-edit">
                                <span class="meta-icon"></span>
                                <input type="text" class="new-session-time-input" value="${session.time || '7:30 PM - 8:30 PM'}" placeholder="Time" />
                            </div>
                        </div>
                        <div class="match-fields ${sessionType === 'match' ? 'active' : ''}">
                            <div class="match-input-group">
                                <label class="match-input-label">Opponent Team</label>
                                <input type="text" class="match-input new-session-opponent-input" placeholder="Enter opponent team name" value="${session.opponent || ''}" />
                            </div>
                            <div class="match-input-group">
                                <label class="match-input-label">Match Type</label>
                                <select class="match-type-select new-session-matchtype-select">
                                    <option value="friendly" ${session.matchType === 'friendly' ? 'selected' : ''}>Friendly</option>
                                    <option value="league" ${session.matchType === 'league' ? 'selected' : ''}>League</option>
                                    <option value="cup" ${session.matchType === 'cup' ? 'selected' : ''}>Cup</option>
                                </select>
                            </div>
                            <div class="match-input-group ${session.matchType === 'cup' ? '' : 'hidden'}" id="cup-stage-group-${tempId}">
                                <label class="match-input-label">Cup Stage</label>
                                <input type="text" class="match-input new-session-cupstage-input" placeholder="e.g., Quarter-finals, Semi-final, Final" value="${session.cupStage || ''}" />
                            </div>
                        </div>
                        <div class="new-session-actions">
                            <button class="save-session-btn" onclick="handleSaveSession('${tempId}')">Save</button>
                            <button class="cancel-session-btn" onclick="handleCancelNewSession()">Cancel</button>
                        </div>
                    </article>
                `;
            }
            
            // Handle cancelled sessions (only show cancelled notice when NOT in edit mode)
            if (session.cancelled && !editMode) {
                return `
                    <article class="session-card cancelled" data-session="${session.id}">
                        <div class="session-header">
                            <span class="session-number">${String(session.id).padStart(2, '0')}</span>
                            <h2 class="session-date">${formatDate(session.date)}</h2>
                        </div>
                        <div class="cancelled-notice">
                            <span class="cancelled-badge">No Training</span>
                            <span class="cancelled-reason">${session.cancelReason || 'Session cancelled'}</span>
                        </div>
                    </article>
                `;
            }

            // Check if it's a match
            const isMatch = session.type === 'match';
            
            if (isMatch) {
                // Generate match card
                return generateMatchCard(session);
            }

            // Generate training session card (existing logic)
            const descContent = session.desc ? parseContent(session.desc) : defaults.desc;
            const warmupContent = session.warmup ? parseContent(session.warmup) : defaults.warmup;
            const drillsContent = session.drills ? parseContent(session.drills) : defaults.drills;
            const gameContent = session.game ? parseContent(session.game) : defaults.game;

            return `
                <article class="session-card ${session.cancelled ? 'cancelled' : ''} ${session.deleted ? 'deleted' : ''}" data-session="${session.id}">
                    <div class="session-header">
                        <span class="session-number">${String(session.id).padStart(2, '0')}</span>
                        ${editMode ? `
                            <div class="session-date-edit">
                                <label>Date:</label>
                                <input type="date" class="session-date-input" value="${session.date ? new Date(session.date).toISOString().split('T')[0] : ''}" data-session="${session.id}" data-field="date" />
                            </div>
                        ` : `
                        <h2 class="session-date">${formatDate(session.date)}</h2>
                        `}
                        <div class="session-meta">
                            ${editMode ? `
                                <div class="meta-item meta-item-edit">
                                    <span class="meta-icon"></span>
                                    <input type="text" class="meta-input" value="${session.location || 'The Aura'}" data-session="${session.id}" data-field="location" placeholder="Location" />
                                </div>
                                <div class="meta-item meta-item-edit">
                                    <span class="meta-icon"></span>
                                    <input type="text" class="meta-input" value="${session.time || '7:30 PM - 8:30 PM'}" data-session="${session.id}" data-field="time" placeholder="Time" />
                                </div>
                            ` : `
                            <div class="meta-item">
                                <span class="meta-icon"></span>
                                    <span>${session.location || 'The Aura'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon"></span>
                                    <span>${session.time || '7:30 PM - 8:30 PM'}</span>
                            </div>
                            `}
                        </div>
                        <div class="session-description">
                            <div class="activity-content activity-display ${!session.desc ? 'placeholder' : ''}" data-session="${session.id}" data-field="desc">${descContent}</div>
                            <textarea class="activity-input hidden" data-session="${session.id}" data-field="desc" placeholder="Add a description or focus for this session...">${session.desc}</textarea>
                        </div>
                    </div>
                    <div class="session-activities">
                        <div class="activity-block warmup">
                            <div class="activity-header">
                                <span class="activity-title">Warm-up</span>
                                <span class="activity-duration">10 mins</span>
                            </div>
                            <div class="activity-content activity-display ${!session.warmup ? 'placeholder' : ''}" data-session="${session.id}" data-field="warmup">${warmupContent}</div>
                            <textarea class="activity-input hidden" data-session="${session.id}" data-field="warmup" placeholder="Enter warm-up activities...">${session.warmup}</textarea>
                        </div>
                        <div class="activity-block drills">
                            <div class="activity-header">
                                <span class="activity-title">Drills</span>
                                <span class="activity-duration">20 mins</span>
                            </div>
                            <div class="activity-content activity-display ${!session.drills ? 'placeholder' : ''}" data-session="${session.id}" data-field="drills">${drillsContent}</div>
                            <textarea class="activity-input hidden" data-session="${session.id}" data-field="drills" placeholder="Enter drills for this session...">${session.drills}</textarea>
                        </div>
                        <div class="activity-block match">
                            <div class="activity-header">
                                <span class="activity-title">Match</span>
                                <span class="activity-duration">30 mins</span>
                            </div>
                            <div class="activity-content activity-display ${!session.game ? 'placeholder' : ''}" data-session="${session.id}" data-field="game">${gameContent}</div>
                            <textarea class="activity-input hidden" data-session="${session.id}" data-field="game" placeholder="Enter match details...">${session.game}</textarea>
                        </div>
                    </div>
                    ${session.cancelled && !editMode ? `
                        <div style="padding: 12px 20px; background: rgba(239, 68, 68, 0.1); border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 18px;"></span>
                            <div style="flex: 1;">
                                <div style="font-size: 12px; font-weight: 700; color: #ef4444; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Session Cancelled</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">${session.cancelReason || 'No reason provided'}</div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="session-cancel-controls hidden">
                        <div class="cancel-toggle-group">
                            <label for="cancel-${session.id}" class="cancel-toggle-label">Cancel this session</label>
                            <div class="cancel-toggle-switch">
                                <input type="checkbox" id="cancel-${session.id}" ${session.cancelled ? 'checked' : ''} data-session="${session.id}" />
                                <span class="cancel-toggle-slider"></span>
                            </div>
                        </div>
                        <input type="text" class="cancel-reason-input" id="cancel-reason-${session.id}" placeholder="Reason for cancellation..." value="${session.cancelReason || ''}" data-session="${session.id}" ${!session.cancelled ? 'disabled' : ''} />
                        <button class="delete-session-btn" onclick="handleDeleteSession(${session.id})" data-session="${session.id}">
                            <span class="delete-icon"></span>
                            <span>Delete Session</span>
                        </button>
                    </div>
                </article>
            `;
        }

        function generateMatchCard(session) {
            const matchTypeBadgeClass = session.matchType || 'friendly';
            const matchTypeLabel = session.matchType === 'cup' ? 'Cup Match' : session.matchType === 'league' ? 'League Match' : 'Friendly Match';
            
            // Calculate match number (count only matches up to this one)
            const matchesUpToThis = sessions.filter(s => s.type === 'match' && !s.deleted && s.id <= session.id).length;
            
            return `
                <article class="session-card match-card ${session.deleted ? 'deleted' : ''}" data-session="${session.id}" onclick="handleMatchCardClick(event, ${session.id})">
                    <div class="session-card-front">
                        <div class="session-header">
                            <span class="session-number">M${String(matchesUpToThis).padStart(2, '0')}</span>
                            <div class="match-type-badge ${matchTypeBadgeClass}">${matchTypeLabel}</div>
                            ${editMode ? `
                                <div class="session-date-edit">
                                    <label>Date:</label>
                                    <input type="date" class="session-date-input" value="${session.date ? new Date(session.date).toISOString().split('T')[0] : ''}" data-session="${session.id}" data-field="date" onclick="event.stopPropagation()" />
                                </div>
                            ` : `
                                <h2 class="session-date">${formatDate(session.date)}</h2>
                            `}
                            ${session.cupStage && !editMode ? `<div class="cup-stage">${session.cupStage}</div>` : ''}
                        </div>
                        ${editMode ? `
                            <div class="match-input-group">
                                <label class="match-input-label">Opponent Team</label>
                                <input type="text" class="match-input" value="${session.opponent || ''}" data-session="${session.id}" data-field="opponent" placeholder="Enter opponent team name" onclick="event.stopPropagation()" />
                            </div>
                            <div class="match-input-group">
                                <label class="match-input-label">Match Type</label>
                                <select class="match-type-select" data-session="${session.id}" data-field="matchType" onclick="event.stopPropagation()" onchange="handleMatchTypeChange(${session.id}, this.value)">
                                    <option value="friendly" ${session.matchType === 'friendly' ? 'selected' : ''}>Friendly</option>
                                    <option value="league" ${session.matchType === 'league' ? 'selected' : ''}>League</option>
                                    <option value="cup" ${session.matchType === 'cup' ? 'selected' : ''}>Cup</option>
                                </select>
                            </div>
                            <div class="match-input-group ${session.matchType === 'cup' ? '' : 'hidden'}" id="match-cup-stage-${session.id}">
                                <label class="match-input-label">Cup Stage</label>
                                <input type="text" class="match-input" value="${session.cupStage || ''}" data-session="${session.id}" data-field="cupStage" placeholder="e.g., Quarter-finals, Semi-final, Final" onclick="event.stopPropagation()" />
                            </div>
                        ` : `
                            <div class="opponent-name">vs ${session.opponent || defaults.opponent}</div>
                        `}
                        <div class="session-meta">
                            ${editMode ? `
                                <div class="meta-item meta-item-edit">
                                    <span class="meta-icon"></span>
                                    <input type="text" class="meta-input" value="${session.location || 'The Aura'}" data-session="${session.id}" data-field="location" placeholder="Location" onclick="event.stopPropagation()" />
                                </div>
                                <div class="meta-item meta-item-edit">
                                    <span class="meta-icon"></span>
                                    <input type="text" class="meta-input" value="${session.time || '7:30 PM - 8:30 PM'}" data-session="${session.id}" data-field="time" placeholder="Time" onclick="event.stopPropagation()" />
                                </div>
                            ` : `
                                <div class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>${session.location || 'The Aura'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-icon"></span>
                                    <span>${session.time || '7:30 PM - 8:30 PM'}</span>
                                </div>
                            `}
                        </div>
                        <div class="match-score-section" style="padding: 10px 20px; margin-top: 10px;">
                            ${editMode ? `
                                <div class="score-inputs" style="display: flex; gap: 10px; align-items: center; justify-content: center;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Score:</span>
                                    <input type="number" 
                                           class="score-input" 
                                           value="${session.teamScore || ''}" 
                                           placeholder="0"
                                           min="0"
                                           style="width: 50px; text-align: center; font-size: 18px; font-weight: bold; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-primary);"
                                           onclick="event.stopPropagation()"
                                           onchange="updateMatchScore('${session.id}', this.value, document.getElementById('opponent-score-${session.id}').value)"
                                           id="team-score-${session.id}">
                                    <span style="font-size: 20px; font-weight: bold; color: var(--text-secondary);">-</span>
                                    <input type="number" 
                                           class="score-input" 
                                           value="${session.opponentScore || ''}" 
                                           placeholder="0"
                                           min="0"
                                           style="width: 50px; text-align: center; font-size: 18px; font-weight: bold; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-primary);"
                                           onclick="event.stopPropagation()"
                                           onchange="updateMatchScore('${session.id}', document.getElementById('team-score-${session.id}').value, this.value)"
                                           id="opponent-score-${session.id}">
                                </div>
                            ` : (session.teamScore !== undefined && session.teamScore !== '') ? `
                                <div class="match-result-display" style="text-align: center; margin: 8px 0;">
                                    <div class="score-display" style="font-size: 28px; font-weight: bold; color: var(--accent);">
                                        ${session.teamScore} - ${session.opponentScore}
                                    </div>
                                    ${session.result ? `
                                        <div class="result-badge ${session.result}" style="display: inline-block; margin-top: 5px; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
                                            ${session.result === 'win' ? 'background: rgba(0, 255, 100, 0.2); color: #00ff64;' : ''}
                                            ${session.result === 'draw' ? 'background: rgba(255, 200, 0, 0.2); color: #ffc800;' : ''}
                                            ${session.result === 'loss' ? 'background: rgba(255, 50, 50, 0.2); color: #ff3232;' : ''}">
                                            ${session.result}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                        ${session.cancelled && !editMode ? `
                            <div style="padding: 12px 20px; background: rgba(239, 68, 68, 0.1); border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; margin-top: 16px;">
                                <span style="font-size: 18px;"></span>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; font-weight: 700; color: #ef4444; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Match Cancelled</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">${session.cancelReason || 'No reason provided'}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${editMode ? `
                            <div class="session-cancel-controls" style="margin-top: 16px;">
                                <div class="cancel-toggle-group">
                                    <label for="cancel-${session.id}" class="cancel-toggle-label">Cancel this match</label>
                                    <div class="cancel-toggle-switch">
                                        <input type="checkbox" id="cancel-${session.id}" ${session.cancelled ? 'checked' : ''} data-session="${session.id}" onclick="event.stopPropagation()" />
                                        <span class="cancel-toggle-slider"></span>
                                    </div>
                                </div>
                                <input type="text" class="cancel-reason-input" id="cancel-reason-${session.id}" placeholder="Reason for cancellation..." value="${session.cancelReason || ''}" data-session="${session.id}" ${!session.cancelled ? 'disabled' : ''} onclick="event.stopPropagation()" />
                                <button class="delete-session-btn" onclick="event.stopPropagation(); handleDeleteSession(${session.id})" data-session="${session.id}">
                                    <span class="delete-icon"></span>
                                    <span>Delete Match</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="session-card-back">
                        ${generateMatchBackContent(session)}
                    </div>
                </article>
            `;
        }

        function generateMatchBackContent(session) {
            const attendance = session.attendance || [];
            const captain = session.captain || '';
            const matchGoals = session.matchGoals || {};
            
            // Get all active players
            const activePlayers = players.filter(p => {
                const returning = (p.returning || '').toString().toLowerCase().trim();
                const playerName = (p.player || '').toString().toLowerCase();
                return p.player && 
                       p.player !== '?' && 
                       !playerName.includes('child') &&
                       returning !== 'no' &&
                       !p.deleted;
            }).sort((a, b) => (a.player || '').localeCompare(b.player || ''));
            
            const attendingPlayers = activePlayers.filter(p => attendance.includes(p.player));
            
            return `
                <div class="attendance-section">
                    <h3 class="attendance-section-title">Match Attendance</h3>
                    <div class="attendance-header">
                        <span class="attendance-header-label"></span>
                        <span class="attendance-header-player">Player</span>
                        <span class="attendance-header-captain">Captain</span>
                    </div>
                    <div class="attendance-checklist" id="attendance-list-${session.id}">
                        ${activePlayers.map(p => `
                            <div class="attendance-item">
                                <input type="checkbox" 
                                       class="attendance-checkbox" 
                                       data-session="${session.id}" 
                                       data-player="${p.player}"
                                       ${attendance.includes(p.player) ? 'checked' : ''}
                                       onclick="event.stopPropagation(); handleAttendanceChange(${session.id}, '${p.player}', this.checked)">
                                <span class="attendance-player-name">${p.player}</span>
                                <input type="checkbox" 
                                       class="captain-checkbox" 
                                       data-session="${session.id}" 
                                       data-player="${p.player}"
                                       ${captain === p.player ? 'checked' : ''}
                                       ${!attendance.includes(p.player) ? 'disabled' : ''}
                                       onclick="event.stopPropagation(); handleCaptainCheckbox(${session.id}, '${p.player}', this.checked)"
                                       title="Captain">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="goal-scorers-section">
                        <h3 class="attendance-section-title">Goal Scorers</h3>
                        <div id="goal-scorers-${session.id}">
                            ${attendingPlayers.length > 0 ? attendingPlayers.map(p => `
                                <div class="goal-scorer-item">
                                    <span class="goal-scorer-name">${p.player}</span>
                                    <div class="goal-scorer-controls">
                                        <button class="goal-btn" onclick="event.stopPropagation(); updateGoals(${session.id}, '${p.player}', -1)" ${(matchGoals[p.player] || 0) === 0 ? 'disabled' : ''}></button>
                                        <span class="goal-count">${matchGoals[p.player] || 0}</span>
                                        <button class="goal-btn" onclick="event.stopPropagation(); updateGoals(${session.id}, '${p.player}', 1)">+</button>
                                    </div>
                                </div>
                            `).join('') : '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No players attending yet</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to select session type for new sessions
        window.selectSessionType = function(tempId, type) {
            const card = document.querySelector(`.session-card[data-temp-id="${tempId}"]`);
            if (!card) return;
            
            // Update button states
            card.querySelectorAll('.type-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.type === type) {
                    btn.classList.add('selected');
                }
            });
            
            // Show/hide match fields
            const matchFields = card.querySelector('.match-fields');
            if (matchFields) {
                if (type === 'match') {
                    matchFields.classList.add('active');
                } else {
                    matchFields.classList.remove('active');
                }
            }
            
            // Update session in array
            const session = sessions.find(s => s._tempId === tempId);
            if (session) {
                session.type = type;
            }
            
            // Handle match type select change to show/hide cup stage
            const matchTypeSelect = card.querySelector('.new-session-matchtype-select');
            if (matchTypeSelect) {
                matchTypeSelect.addEventListener('change', function() {
                    const cupStageGroup = document.getElementById(`cup-stage-group-${tempId}`);
                    if (cupStageGroup) {
                        if (this.value === 'cup') {
                            cupStageGroup.classList.remove('hidden');
                        } else {
                            cupStageGroup.classList.add('hidden');
                        }
                    }
                });
            }
        };

        // Handle match type change in edit mode
        window.handleMatchTypeChange = function(sessionId, matchType) {
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                session.matchType = matchType;
                
                // Show/hide cup stage field
                const cupStageGroup = document.getElementById(`match-cup-stage-${sessionId}`);
                if (cupStageGroup) {
                    if (matchType === 'cup') {
                        cupStageGroup.classList.remove('hidden');
                    } else {
                        cupStageGroup.classList.add('hidden');
                        // Clear cup stage if not a cup match
                        session.cupStage = '';
                        const cupStageInput = cupStageGroup.querySelector('input');
                        if (cupStageInput) cupStageInput.value = '';
                    }
                }
            }
        };

        // Handle match card click for flipping
        window.handleMatchCardClick = function(event, sessionId) {
            // Don't flip if clicking on interactive elements
            const target = event.target;
            if (target.closest('input, button, select, .attendance-checkbox, .captain-checkbox, .goal-btn, .captain-selector')) {
                return; // Don't stop propagation here, let the event bubble to the specific handlers
            }
            
            const card = event.currentTarget;
            card.classList.toggle('flipped');
        };

        // Handle attendance checkbox change
        window.handleAttendanceChange = function(sessionId, playerName, isChecked) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            if (!session.attendance) {
                session.attendance = [];
            }
            
            if (isChecked) {
                if (!session.attendance.includes(playerName)) {
                    session.attendance.push(playerName);
                }
                // Enable captain checkbox
                const captainCheckbox = document.querySelector(`.captain-checkbox[data-session="${sessionId}"][data-player="${playerName}"]`);
                if (captainCheckbox) {
                    captainCheckbox.disabled = false;
                }
            } else {
                session.attendance = session.attendance.filter(p => p !== playerName);
                // If unchecked player was captain, clear captain
                if (session.captain === playerName) {
                    session.captain = '';
                }
                // Disable and uncheck captain checkbox
                const captainCheckbox = document.querySelector(`.captain-checkbox[data-session="${sessionId}"][data-player="${playerName}"]`);
                if (captainCheckbox) {
                    captainCheckbox.checked = false;
                    captainCheckbox.disabled = true;
                }
                // Clear any goals for this player
                if (session.matchGoals && session.matchGoals[playerName]) {
                    delete session.matchGoals[playerName];
                }
            }
            
            // Update goal scorers display
            updateGoalScorersDisplay(sessionId);
            
            // Auto-save
            saveMatchData(sessionId);
        };

        // Handle captain selection change
        window.handleCaptainChange = function(sessionId, playerName) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            session.captain = playerName;
        };

        // Handle captain checkbox change
        window.handleCaptainCheckbox = function(sessionId, playerName, isChecked) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Only one captain at a time - uncheck all others
            if (isChecked) {
                session.captain = playerName;
                // Uncheck all other captain checkboxes
                document.querySelectorAll(`.captain-checkbox[data-session="${sessionId}"]`).forEach(cb => {
                    if (cb.dataset.player !== playerName) {
                        cb.checked = false;
                    }
                });
            } else {
                // If unchecking the current captain, clear it
                if (session.captain === playerName) {
                    session.captain = '';
                }
            }
            
            // Auto-save
            saveMatchData(sessionId);
        };

        // Update goals for a player
        window.updateGoals = function(sessionId, playerName, delta) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            if (!session.matchGoals) {
                session.matchGoals = {};
            }
            
            const currentGoals = session.matchGoals[playerName] || 0;
            const newGoals = Math.max(0, currentGoals + delta);
            
            if (newGoals === 0) {
                delete session.matchGoals[playerName];
            } else {
                session.matchGoals[playerName] = newGoals;
            }
            
            // Update the specific goal count display - find by matching text content
            const goalScorerItems = document.querySelectorAll(`#goal-scorers-${sessionId} .goal-scorer-item`);
            goalScorerItems.forEach(item => {
                const nameEl = item.querySelector('.goal-scorer-name');
                if (nameEl && nameEl.textContent.trim() === playerName) {
                    const countEl = item.querySelector('.goal-count');
                    const minusBtn = item.querySelector('.goal-btn:first-child');
                    if (countEl) countEl.textContent = newGoals;
                    if (minusBtn) minusBtn.disabled = newGoals === 0;
                }
            });
            
            // Auto-save
            saveMatchData(sessionId);
        };

        // Update captain selector options based on attendance
        function updateCaptainSelector(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const captainSelector = document.querySelector(`.captain-selector[data-session="${sessionId}"]`);
            if (!captainSelector) return;
            
            const attendance = session.attendance || [];
            const currentCaptain = session.captain || '';
            
            // Get all active players
            const activePlayers = players.filter(p => {
                const returning = (p.returning || '').toString().toLowerCase().trim();
                const playerName = (p.player || '').toString().toLowerCase();
                return p.player && 
                       p.player !== '?' && 
                       !playerName.includes('child') &&
                       returning !== 'no' &&
                       !p.deleted;
            }).filter(p => attendance.includes(p.player)).sort((a, b) => (a.player || '').localeCompare(b.player || ''));
            
            // Rebuild options
            captainSelector.innerHTML = '<option value="">Select captain...</option>' +
                activePlayers.map(p => `<option value="${p.player}" ${currentCaptain === p.player ? 'selected' : ''}>${p.player}</option>`).join('');
        }

        // Update match score
        window.updateMatchScore = function(sessionId, teamScore, opponentScore) {
            const session = sessions.find(s => s.id == sessionId);
            if (!session) return;
            
            session.teamScore = teamScore;
            session.opponentScore = opponentScore;
            
            // Auto-calculate result
            const team = parseInt(teamScore) || 0;
            const opponent = parseInt(opponentScore) || 0;
            
            if (teamScore !== '' && opponentScore !== '') {
                if (team > opponent) {
                    session.result = 'win';
                } else if (team < opponent) {
                    session.result = 'loss';
                } else {
                    session.result = 'draw';
                }
            } else {
                session.result = '';
            }
            
            saveData();
        };

        // Update goal scorers display based on attendance
        function updateGoalScorersDisplay(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const goalScorersContainer = document.getElementById(`goal-scorers-${sessionId}`);
            if (!goalScorersContainer) return;
            
            const attendance = session.attendance || [];
            const matchGoals = session.matchGoals || {};
            
            // Get all active players who are attending
            const activePlayers = players.filter(p => {
                const returning = (p.returning || '').toString().toLowerCase().trim();
                const playerName = (p.player || '').toString().toLowerCase();
                return p.player && 
                       p.player !== '?' && 
                       !playerName.includes('child') &&
                       returning !== 'no' &&
                       !p.deleted &&
                       attendance.includes(p.player);
            }).sort((a, b) => (a.player || '').localeCompare(b.player || ''));
            
            if (activePlayers.length === 0) {
                goalScorersContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No players attending yet</p>';
                return;
            }
            
            goalScorersContainer.innerHTML = activePlayers.map(p => {
                const goals = matchGoals[p.player] || 0;
                return `
                    <div class="goal-scorer-item">
                        <span class="goal-scorer-name">${p.player}</span>
                        <div class="goal-scorer-controls">
                            <button class="goal-btn" onclick="event.stopPropagation(); updateGoals(${sessionId}, '${p.player}', -1)" ${goals === 0 ? 'disabled' : ''}></button>
                            <span class="goal-count">${goals}</span>
                            <button class="goal-btn" onclick="event.stopPropagation(); updateGoals(${sessionId}, '${p.player}', 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Save match data
        window.saveMatchData = async function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Integrate match goals with player goals
            const matchDate = session.date ? new Date(session.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            const matchGoals = session.matchGoals || {};
            const attendingPlayers = session.attendance || [];
            
            // Set goals for each player's record (not add, to avoid duplicates)
            for (const [playerName, goalCount] of Object.entries(matchGoals)) {
                if (goalCount > 0) {
                    setGoals(playerName, matchDate, goalCount);
                } else {
                    // If goals were removed, delete the entry
                    deleteGoal(playerName, matchDate);
                }
            }
            
            // Clear goals for any player who is not attending but has goals for this match date
            // This handles cases where a player was removed from attendance after scoring
            players.forEach(player => {
                const playerName = player.player;
                if (!playerName) return;
                
                // If player is not attending and not in matchGoals, check if they have goals for this date
                if (!attendingPlayers.includes(playerName)) {
                    const goals = getPlayerGoals(playerName);
                    if (goals[matchDate]) {
                        deleteGoal(playerName, matchDate);
                    }
                }
            });
            
            // Save session data
            await saveData();
            await saveSessionsList();
            
            showSaveIndicator();
            
            // Always refresh player display if on players tab
            const playersTab = document.getElementById('players-tab');
            if (playersTab && playersTab.classList.contains('active')) {
                renderPlayers();
            }
        };

        function renderSessions() {
            const sessionsContainer = document.getElementById('sessions');
            
            // Filter sessions based on showPastSessions and showDeletedSessions flags
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const filteredSessions = sessions.filter(session => {
                // Always show new sessions
                if (session._isNew) {
                    return true;
                }
                
                // Hide deleted sessions unless showDeletedSessions is true
                if (session.deleted && !showDeletedSessions) {
                    return false;
                }
                
                // Hide past sessions unless showPastSessions is true
                const sessionDate = new Date(session.date);
                sessionDate.setHours(0, 0, 0, 0);
                if (sessionDate < today && !showPastSessions) {
                    return false;
                }
                
                // Filter by session type
                const sessionType = session.type || 'training';
                if (sessionType === 'training' && !showTraining) {
                    return false;
                }
                if (sessionType === 'match' && !showMatches) {
                    return false;
                }
                
                return true;
            }).sort((a, b) => {
                // Sort by date (ascending - earliest first)
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });
            
            let html = filteredSessions.map(generateSessionCard).join('');
            
            // Add "Add Session" button in edit mode
            if (editMode) {
                html += `
                    <div class="add-session-container">
                        <div class="add-session-form">
                            <input type="date" class="new-session-date-input" id="newSessionDate" />
                            <button class="add-session-btn" onclick="handleAddSession()">
                                <span class="add-session-icon">+</span>
                                <span class="add-session-text">Add New Session</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            sessionsContainer.innerHTML = html;
            
            document.querySelectorAll('.activity-input').forEach(input => {
                input.addEventListener('input', e => {
                    const session = sessions.find(s => s.id === parseInt(e.target.dataset.session));
                    const field = e.target.dataset.field;
                    if (session && field) session[field] = e.target.value;
                });
            });
            
            // Handle date, location, and time inputs
            document.querySelectorAll('.session-date-input, .meta-input').forEach(input => {
                input.addEventListener('change', e => {
                    const session = sessions.find(s => s.id === parseInt(e.target.dataset.session));
                    const field = e.target.dataset.field;
                    if (session && field) {
                        if (field === 'date') {
                            session.date = new Date(e.target.value);
                        } else {
                            session[field] = e.target.value;
                        }
                        saveSessionsList();
                    }
                });
            });
            
            // Handle match-specific field inputs (opponent, matchType, cupStage)
            document.querySelectorAll('.match-input, .match-type-select').forEach(input => {
                input.addEventListener('change', e => {
                    const session = sessions.find(s => s.id === parseInt(e.target.dataset.session));
                    const field = e.target.dataset.field;
                    if (session && field) {
                        session[field] = e.target.value;
                        saveSessionsList();
                    }
                });
            });
            
            applyEditMode();
            
            // Setup cancel controls if in edit mode
            if (editMode) {
                setupCancelControls();
                
                // Set default date for new session date picker
                const newSessionDateInput = document.getElementById('newSessionDate');
                if (newSessionDateInput && !newSessionDateInput.value) {
                    // Default to 7 days after the last session, or today if no sessions
                    let defaultDate = new Date();
                    if (sessions.length > 0) {
                        const sortedSessions = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
                        const lastSession = sortedSessions[0];
                        defaultDate = new Date(lastSession.date);
                        defaultDate.setDate(defaultDate.getDate() + 7);
                    }
                    newSessionDateInput.value = defaultDate.toISOString().split('T')[0];
                }
            }
        }
        
        window.handleDeleteSession = async function(sessionId) {
            if (!confirm('Are you sure you want to delete this session? It will be hidden but can be restored by showing past & deleted sessions.')) {
                return;
            }
            
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                session.deleted = true;
                await saveSessionsList();
                renderSessions();
            }
        };

        window.cleanupDeletedSessions = async function() {
            const deletedSessions = sessions.filter(s => s.deleted);
            const deletedCount = deletedSessions.length;
            
            if (deletedCount === 0) {
                alert('No deleted sessions to clean up.');
                return;
            }
            
            if (!confirm(`Are you sure you want to permanently delete ${deletedCount} session(s)? This action cannot be undone.`)) {
                return;
            }
            
            // Get IDs of deleted sessions before removing them
            const deletedSessionIds = deletedSessions.map(s => s.id);
            
            // Remove deleted sessions from the array
            const originalLength = sessions.length;
            sessions = sessions.filter(s => !s.deleted);
            
            // Also remove their data from Firebase sessions node
            if (database) {
                try {
                    // Remove session content from Firebase
                    const sessionsRef = database.ref('sessions');
                    for (const sessionId of deletedSessionIds) {
                        await sessionsRef.child(sessionId).remove();
                    }
                } catch (e) {
                    console.error('Failed to remove session data from Firebase:', e);
                }
            }
            
            // Save updated sessions list
            await saveSessionsList();
            
            // Re-render
            renderSessions();
            
            alert(`Successfully removed ${originalLength - sessions.length} deleted session(s).`);
        };
        
        window.handleAddSession = function() {
            // Create a temporary new session with a unique ID
            const tempId = 'new-session-' + Date.now();
            
            // Default date: 7 days after the last session, or today if no sessions
            let defaultDate = new Date();
            if (sessions.length > 0) {
                const sortedSessions = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastSession = sortedSessions[0];
                defaultDate = new Date(lastSession.date);
                defaultDate.setDate(defaultDate.getDate() + 7);
            }
            
            const newSession = {
                id: null, // Will be assigned when saved
                date: defaultDate,
                type: 'training', // Default to training
                cancelled: false,
                cancelReason: '',
                location: 'The Aura',
                time: '7:30 PM - 8:30 PM',
                // Training fields
                desc: '',
                warmup: '',
                drills: '',
                game: '',
                // Match fields
                opponent: '',
                matchType: 'friendly',
                cupStage: '',
                attendance: [],
                captain: '',
                matchGoals: {},
                deleted: false,
                _tempId: tempId,
                _isNew: true
            };
            
            // Add to sessions array
            sessions.push(newSession);
            
            // Re-render to show the empty card
            renderSessions();
            
            // Scroll to the new session card
            setTimeout(() => {
                const newSessionCard = document.querySelector(`.session-card[data-temp-id="${tempId}"]`);
                if (newSessionCard) {
                    newSessionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };

        window.handleSaveSession = async function(tempId) {
            const sessionCard = document.querySelector(`.session-card[data-temp-id="${tempId}"]`);
            if (!sessionCard) return;
            
            const dateInput = sessionCard.querySelector('.new-session-date-input');
            const locationInput = sessionCard.querySelector('.new-session-location-input');
            const timeInput = sessionCard.querySelector('.new-session-time-input');
            
            const dateStr = dateInput ? dateInput.value : '';
            const location = locationInput ? locationInput.value.trim() : '';
            const time = timeInput ? timeInput.value.trim() : '';
            
            if (!dateStr) {
                alert('Please enter a session date.');
                if (dateInput) dateInput.focus();
                return;
            }
            
            const newDate = new Date(dateStr);
            if (isNaN(newDate.getTime())) {
                alert('Invalid date format.');
                if (dateInput) dateInput.focus();
                return;
            }
            
            // Find and update the session
            const sessionIndex = sessions.findIndex(s => s._tempId === tempId);
            if (sessionIndex !== -1) {
                const session = sessions[sessionIndex];
                
                // Determine session type
                const selectedType = sessionCard.querySelector('.type-option.selected');
                const sessionType = selectedType ? selectedType.dataset.type : 'training';
                
                // Get match-specific fields if it's a match
                if (sessionType === 'match') {
                    const opponentInput = sessionCard.querySelector('.new-session-opponent-input');
                    const matchTypeSelect = sessionCard.querySelector('.new-session-matchtype-select');
                    const cupStageInput = sessionCard.querySelector('.new-session-cupstage-input');
                    
                    const opponent = opponentInput ? opponentInput.value.trim() : '';
                    const matchType = matchTypeSelect ? matchTypeSelect.value : 'friendly';
                    const cupStage = cupStageInput ? cupStageInput.value.trim() : '';
                    
                    if (!opponent) {
                        alert('Please enter the opponent team name.');
                        if (opponentInput) opponentInput.focus();
                        return;
                    }
                    
                    session.opponent = opponent;
                    session.matchType = matchType;
                    session.cupStage = matchType === 'cup' ? cupStage : '';
                    session.attendance = [];
                    session.captain = '';
                    session.matchGoals = {};
                }
                
                // Find the next available ID
                const deletedSessions = sessions.filter(s => s.deleted && !s._isNew).sort((a, b) => a.id - b.id);
                let newId;
                
                if (deletedSessions.length > 0) {
                    newId = deletedSessions[0].id;
                    const indexToRemove = sessions.findIndex(s => s.id === newId && !s._isNew);
                    if (indexToRemove !== -1) {
                        sessions.splice(indexToRemove, 1);
                    }
                } else {
                    const activeSessions = sessions.filter(s => !s.deleted && !s._isNew);
                    const maxId = activeSessions.length > 0 ? Math.max(...activeSessions.map(s => s.id)) : 0;
                    newId = maxId + 1;
                }
                
                session.id = newId;
                session.date = newDate;
                session.location = location || 'The Aura';
                session.time = time || '7:30 PM - 8:30 PM';
                session.type = sessionType;
                delete session._tempId;
                delete session._isNew;
            }
            
            // Sort sessions by ID
            sessions.sort((a, b) => {
                if (a.id === null) return 1;
                if (b.id === null) return -1;
                return a.id - b.id;
            });
            
            // Save to Firebase
            await saveSessionsList();
            await saveData();
            
            // Re-render
            renderSessions();
        };

        window.handleCancelNewSession = function() {
            // Remove the temporary session from the array
            const sessionIndex = sessions.findIndex(s => s._isNew);
            if (sessionIndex !== -1) {
                sessions.splice(sessionIndex, 1);
            }
            
            // Re-render
            renderSessions();
        };

        function applyEditMode() {
            // Apply edit mode to activity inputs and displays (skip new session cards)
            document.querySelectorAll('.activity-input').forEach(el => {
                if (el.closest('.new-session-card')) return; // Skip new session cards
                el.classList.toggle('hidden', !editMode);
            });
            document.querySelectorAll('.activity-display').forEach(el => {
                if (el.closest('.new-session-card')) return; // Skip new session cards
                el.classList.toggle('hidden', editMode);
            });
            document.querySelectorAll('.session-cancel-controls').forEach(el => {
                if (el.closest('.new-session-card')) return; // Skip new session cards
                el.classList.toggle('hidden', !editMode);
            });
        }

        function setupEditMode() {
            const toggle = document.getElementById('editMode');
            
            if (!toggle) return;
            
            // Setup show past sessions toggle
            const showPastToggle = document.getElementById('showPastSessions');
            if (showPastToggle) {
                showPastToggle.addEventListener('change', () => {
                    showPastSessions = showPastToggle.checked;
                    renderSessions();
                });
            }
            
            // Setup show deleted sessions toggle
            const showDeletedToggle = document.getElementById('showDeletedSessions');
            if (showDeletedToggle) {
                showDeletedToggle.addEventListener('change', () => {
                    showDeletedSessions = showDeletedToggle.checked;
                    renderSessions();
                });
            }

            toggle.addEventListener('change', () => {
                if (!toggle.checked && editMode) {
                    document.querySelectorAll('.activity-input').forEach(input => {
                        const session = sessions.find(s => s.id === parseInt(input.dataset.session));
                        const field = input.dataset.field;
                        if (session && field) session[field] = input.value;
                        
                        const display = document.querySelector(`.activity-display[data-session="${input.dataset.session}"][data-field="${field}"]`);
                        if (display) {
                            display.innerHTML = session[field] ? parseContent(session[field]) : defaults[field];
                            display.classList.toggle('placeholder', !session[field]);
                        }
                    });
                    
                    // Save date, location, and time
                    document.querySelectorAll('.session-date-input, .meta-input').forEach(input => {
                        const session = sessions.find(s => s.id === parseInt(input.dataset.session));
                        const field = input.dataset.field;
                        if (session && field) {
                            if (field === 'date') {
                                session.date = new Date(input.value);
                            } else {
                                session[field] = input.value;
                            }
                        }
                    });
                    
                    // Save cancelled status and reason
                    document.querySelectorAll('.cancel-toggle-switch input').forEach(toggle => {
                        const session = sessions.find(s => s.id === parseInt(toggle.dataset.session));
                        if (session) {
                            session.cancelled = toggle.checked;
                        }
                    });
                    
                    document.querySelectorAll('.cancel-reason-input').forEach(input => {
                        const session = sessions.find(s => s.id === parseInt(input.dataset.session));
                        if (session) {
                            session.cancelReason = input.value.trim();
                        }
                    });
                    
                    // Save match-specific fields (opponent, matchType, cupStage)
                    document.querySelectorAll('.match-input, .match-type-select').forEach(input => {
                        const session = sessions.find(s => s.id === parseInt(input.dataset.session));
                        const field = input.dataset.field;
                        if (session && field) {
                            session[field] = input.value;
                        }
                    });
                    
                    saveData();
                    saveSessionsList();
                }
                
                editMode = toggle.checked;
                
                // Re-render sessions when toggling edit mode so cancelled sessions show full card in edit mode
                renderSessions();
                
                // Setup cancel checkbox handlers when entering edit mode
                if (editMode) {
                    setupCancelControls();
                }
            });
        }
        
        function setupFilterToggles() {
            const showTrainingToggle = document.getElementById('showTraining');
            const showMatchesToggle = document.getElementById('showMatches');
            
            if (showTrainingToggle) {
                showTrainingToggle.addEventListener('change', () => {
                    showTraining = showTrainingToggle.checked;
                    renderSessions();
                });
            }
            
            if (showMatchesToggle) {
                showMatchesToggle.addEventListener('change', () => {
                    showMatches = showMatchesToggle.checked;
                    renderSessions();
                });
            }
        }
        
        function setupCancelControls() {
            // Handle cancel toggle changes
            document.querySelectorAll('.cancel-toggle-switch input').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const sessionId = parseInt(this.dataset.session);
                    const reasonInput = document.getElementById(`cancel-reason-${sessionId}`);
                    if (reasonInput) {
                        reasonInput.disabled = !this.checked;
                        if (!this.checked) {
                            reasonInput.value = '';
                        }
                    }
                });
            });
        }

        function scrollToClosestSession() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find the closest session (prefer upcoming, fallback to most recent past)
            let closestSession = null;
            let smallestDiff = Infinity;
            
            // First try to find the next upcoming session
            for (const session of sessions) {
                const sessionDate = new Date(session.date);
                sessionDate.setHours(0, 0, 0, 0);
                const diff = sessionDate - today;
                
                if (diff >= 0 && diff < smallestDiff) {
                    smallestDiff = diff;
                    closestSession = session;
                }
            }
            
            // If no upcoming session, find the most recent past session
            if (!closestSession) {
                smallestDiff = Infinity;
                for (const session of sessions) {
                    const sessionDate = new Date(session.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    const diff = today - sessionDate;
                    
                    if (diff >= 0 && diff < smallestDiff) {
                        smallestDiff = diff;
                        closestSession = session;
                    }
                }
            }
            
            // Scroll to the closest session
            if (closestSession) {
                const card = document.querySelector(`.session-card[data-session="${closestSession.id}"]`);
                if (card) {
                    setTimeout(() => {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 600); // Wait for animations to complete
                }
            }
        }

        // Players array - loaded from Firebase
        let players = [];

        function getPlayerGoals(playerName) {
            const goalsKey = `goals_${playerName}`;
            const stored = localStorage.getItem(goalsKey);
            return stored ? JSON.parse(stored) : {}; // Changed to object: { date: count }
        }

        function savePlayerGoals(playerName, goals) {
            const goalsKey = `goals_${playerName}`;
            localStorage.setItem(goalsKey, JSON.stringify(goals));
            
            // Save to Firebase
            saveGoalsToFirebase(playerName, goals);
        }

        function getPlayerNotes(playerName) {
            const notesKey = `notes_${playerName}`;
            const stored = localStorage.getItem(notesKey);
            return stored || '';
        }

        function savePlayerNotes(playerName, notes) {
            const notesKey = `notes_${playerName}`;
            localStorage.setItem(notesKey, notes);
            
            // Save to Firebase
            saveNotesToFirebase(playerName, notes);
        }

        function getTotalGoals(goals) {
            return Object.values(goals).reduce((sum, count) => sum + (parseInt(count) || 0), 0);
        }

        function getGoalsPerGame(goals) {
            const uniqueDates = Object.keys(goals).length;
            if (uniqueDates === 0) return 0;
            const totalGoals = getTotalGoals(goals);
            return (totalGoals / uniqueDates).toFixed(2);
        }

        function getRecentGoals(goals, count = 3) {
            const goalEntries = Object.entries(goals)
                .sort((a, b) => new Date(b[0]) - new Date(a[0]))
                .slice(0, count);
            return goalEntries.map(([date, goalCount]) => ({
                date,
                count: parseInt(goalCount) || 0
            }));
        }

        function getGoalsThisMonth(goals) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            return Object.entries(goals).reduce((sum, [date, count]) => {
                const goalDate = new Date(date);
                if (goalDate.getMonth() === currentMonth && goalDate.getFullYear() === currentYear) {
                    return sum + (parseInt(count) || 0);
                }
                return sum;
            }, 0);
        }

        function getGoalsByMonth(goals) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const monthlyGoals = {};
            
            // Initialize all months from February (1) to October (9) with 0 goals
            for (let month = 1; month <= 9; month++) {
                const monthKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                const monthDate = new Date(currentYear, month, 1);
                const monthLabel = monthDate.toLocaleDateString('en-IE', { month: 'short', year: 'numeric' });
                
                monthlyGoals[monthKey] = {
                    label: monthLabel,
                    count: 0
                };
            }
            
            // Add actual goal data for months in the range (February to October)
            Object.entries(goals).forEach(([date, count]) => {
                const goalDate = new Date(date);
                const goalMonth = goalDate.getMonth(); // 0-indexed (0 = Jan, 1 = Feb, ..., 9 = Oct)
                const goalYear = goalDate.getFullYear();
                
                // Only include goals from February (month 1) to October (month 9) in the current year
                if (goalYear === currentYear && goalMonth >= 1 && goalMonth <= 9) {
                    const monthKey = `${goalYear}-${String(goalMonth + 1).padStart(2, '0')}`;
                    if (monthlyGoals[monthKey]) {
                        monthlyGoals[monthKey].count += parseInt(count) || 0;
                    }
                }
            });
            
            // Return all months from February to October, sorted by date
            return Object.entries(monthlyGoals)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([key, data]) => data);
        }

        function addGoals(playerName, date, count) {
            const goals = getPlayerGoals(playerName);
            const currentCount = goals[date] || 0;
            goals[date] = currentCount + parseInt(count);
            savePlayerGoals(playerName, goals);
            return goals;
        }

        function setGoals(playerName, date, count) {
            const goals = getPlayerGoals(playerName);
            goals[date] = parseInt(count);
            savePlayerGoals(playerName, goals);
            return goals;
        }

        function deleteGoal(playerName, date) {
            const goals = getPlayerGoals(playerName);
            delete goals[date];
            savePlayerGoals(playerName, goals);
            return goals;
        }

        async function saveGoalsToFirebase(playerName, goals) {
            if (!database) {
                console.log('Firebase not configured - data saved to localStorage only');
                return;
            }
            
            try {
                const total = getTotalGoals(goals);
                const playerRef = database.ref('players/' + encodeURIComponent(playerName));
                
                // Get existing notes if any
                const existingData = await playerRef.once('value');
                const existingNotes = existingData.val()?.notes || '';
                
                // If goals object is empty and no notes, remove the entire node from Firebase
                if (Object.keys(goals).length === 0 && !existingNotes) {
                    console.log('Removing empty player data from Firebase for', playerName);
                    await playerRef.remove();
                    console.log('Empty player data removed successfully from Firebase for', playerName);
                } else {
                    const data = {
                        player: playerName,
                        goals: goals,
                        total: total,
                        notes: existingNotes,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    console.log('Saving goals to Firebase:', data);
                    
                    // Save to Firebase Realtime Database
                    await playerRef.set(data);
                    
                    console.log('Goals saved successfully to Firebase for', playerName);
                }
            } catch (e) {
                console.error('Failed to save to Firebase:', e);
                // Still saved locally even if Firebase fails
            }
        }

        async function saveNotesToFirebase(playerName, notes) {
            if (!database) {
                console.log('Firebase not configured - data saved to localStorage only');
                return;
            }
            
            try {
                const playerRef = database.ref('players/' + encodeURIComponent(playerName));
                
                // Get existing goals if any
                const existingData = await playerRef.once('value');
                const existingGoals = existingData.val()?.goals || {};
                const existingTotal = existingData.val()?.total || 0;
                
                // If notes is empty and no goals, remove the entire node from Firebase
                if (!notes && Object.keys(existingGoals).length === 0) {
                    console.log('Removing empty player data from Firebase for', playerName);
                    await playerRef.remove();
                    console.log('Empty player data removed successfully from Firebase for', playerName);
                } else {
                    const data = {
                        player: playerName,
                        goals: existingGoals,
                        total: existingTotal,
                        notes: notes,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    console.log('Saving notes to Firebase:', data);
                    
                    // Save to Firebase Realtime Database
                    await playerRef.set(data);
                    
                    console.log('Notes saved successfully to Firebase for', playerName);
                }
            } catch (e) {
                console.error('Failed to save notes to Firebase:', e);
                // Still saved locally even if Firebase fails
            }
        }
        
        async function loadPlayersFromFirebase() {
            if (!database) {
                console.log('Firebase not configured - using empty players array');
                return;
            }
            
            try {
                const playersRef = database.ref('playersList');
                const snapshot = await playersRef.once('value');
                const playersData = snapshot.val();
                
                if (playersData) {
                    // Convert Firebase object to array
                    players = Object.values(playersData);
                    console.log('Players loaded from Firebase:', players.length);
                } else {
                    console.log('No players found in Firebase. Run migratePlayersToFirebase() in console to migrate players.');
                    players = [];
                }
            } catch (e) {
                console.error('Failed to load players from Firebase:', e);
                players = [];
            }
        }
        
        async function loadGoalsFromFirebase() {
            if (!database) {
                console.log('Firebase not configured - loading from localStorage only');
                return;
            }
            
            try {
                // First, clear all existing goal and notes data from localStorage to ensure Firebase is source of truth
                players.forEach(p => {
                    const playerName = p.player;
                    if (playerName) {
                        const goalsKey = `goals_${playerName}`;
                        const notesKey = `notes_${playerName}`;
                        localStorage.removeItem(goalsKey);
                        localStorage.removeItem(notesKey);
                    }
                });
                
                const playersRef = database.ref('players');
                const snapshot = await playersRef.once('value');
                const playersData = snapshot.val();
                
                if (playersData) {
                    // Use Firebase data as source of truth (don't merge with localStorage)
                    Object.keys(playersData).forEach(playerName => {
                        const decodedName = decodeURIComponent(playerName);
                        const firebaseGoals = playersData[playerName].goals || {};
                        const firebaseNotes = playersData[playerName].notes || '';
                        
                        // Use Firebase data directly - it's the source of truth
                        // This ensures deletions are properly reflected
                        const goalsKey = `goals_${decodedName}`;
                        const notesKey = `notes_${decodedName}`;
                        localStorage.setItem(goalsKey, JSON.stringify(firebaseGoals));
                        localStorage.setItem(notesKey, firebaseNotes);
                    });
                    
                    console.log('Goals and notes loaded from Firebase');
                }
            } catch (e) {
                console.error('Failed to load from Firebase:', e);
            }
        }

        function formatGoalDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IE', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function renderGoalsChart(goals) {
            const monthlyData = getGoalsByMonth(goals);
            
            if (monthlyData.length === 0) {
                return '';
            }
            
            const maxGoals = Math.max(...monthlyData.map(m => m.count), 1);
            const chartWidth = 100;
            const chartHeight = 90;
            const padding = 8;
            const barWidth = 2;//(chartWidth - (padding * (monthlyData.length + 1))) / monthlyData.length;
            const topPadding = 15; // Space for goal count text above bars
            const bottomPadding = 35; // Space for rotated month labels
            const maxBarHeight = chartHeight - topPadding - bottomPadding;
            
            let svg = `<div class="goals-chart">
                <div class="goals-chart-title">Goals by Month</div>
                <div class="goals-chart-container">
                    <svg class="goals-chart-svg" viewBox="0 0 ${chartWidth} ${chartHeight}" preserveAspectRatio="none">
            `;
            
            monthlyData.forEach((month, index) => {
                const barHeight = maxGoals > 0 ? (month.count / maxGoals) * maxBarHeight : 0;
                const x = padding + index * (barWidth + padding);
                const barY = chartHeight - bottomPadding - barHeight;
                const monthName = month.label.split(' ')[0];
                const labelX = x + barWidth / 2;
                const labelY = chartHeight - 10;
                
                svg += `
                    <g>
                        <!-- Single color bar -->
                        <rect class="goals-chart-bar" 
                              x="${x}" 
                              y="${barY}" 
                              width="${barWidth}" 
                              height="${barHeight}"
                              rx="1">
                            <title>${month.label}: ${month.count} ${month.count === 1 ? 'goal' : 'goals'}</title>
                        </rect>
                        ${month.count > 0 ? `
                            <text class="goals-chart-value" 
                                  x="${x + barWidth / 2}" 
                                  y="${barY - 6}">${month.count}</text>
                        ` : ''}
                        <!-- Rotated month label (90 degrees) - positioned under each bar -->
                        <g transform="translate(${labelX}, ${labelY}) rotate(-90)">
                            <text class="goals-chart-label-rotated" 
                                  x="0" 
                                  y="0"
                                  text-anchor="middle"
                                  dominant-baseline="central"
                                  style="letter-spacing: 6px;">${monthName}</text>
                        </g>
                    </g>
                `;
            });
            
            svg += `
                    </svg>
                </div>
            </div>`;
            
            return svg;
        }

        function renderPlayers() {
            const container = document.getElementById('players-container');
            
            // Show message if no players loaded
            if (players.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 16px; margin-bottom: 12px;">No players found</p>
                        <p style="font-size: 14px; color: var(--text-muted);">Click "Add Player" to create a new player.</p>
                    </div>
                `;
                return;
            }
            
            // Filter: exclude players where returning = "No" (case-insensitive), exclude invalid entries, and filter by deleted status
            // Always include new players (_isNew)
            let filteredPlayers = players.filter(p => {
                // Always show new players
                if (p._isNew) {
                    return true;
                }
                
                const returning = (p.returning || '').toString().toLowerCase().trim();
                const playerName = (p.player || '').toString().toLowerCase();
                return p.player && 
                       p.player !== '?' && 
                       !playerName.includes('child') &&
                       returning !== 'no';
            });
            
            // Filter by deleted status (but always show new players)
            if (!showDeletedPlayers) {
                filteredPlayers = filteredPlayers.filter(p => !p.deleted || p._isNew);
            }
            
            container.innerHTML = filteredPlayers.map((p, index) => {
                const playerName = p.player || '';
                const goals = getPlayerGoals(playerName);
                const isDeleted = p.deleted || false;
                const isNew = p._isNew || false;
                const tempId = p._tempId || '';
                
                // If it's a new player, show an editable card
                if (isNew) {
                return `
                    <div class="player-card-wrapper">
                            <div class="player-card new-player-card" data-temp-id="${tempId}" data-index="${index}">
                                <div class="player-card-front">
                                    <div class="player-name">
                                        <input type="text" class="player-name-input" placeholder="Player Name" value="${playerName}" />
                                    </div>
                                    <div class="player-details">
                                        <div class="player-detail-item">
                                            <span class="player-detail-label">Jersey #</span>
                                            <input type="text" class="player-jersey-input" placeholder="Jersey Number" value="${p.jersey || ''}" />
                                        </div>
                                        <div class="player-detail-item">
                                            <span class="player-detail-label">Parent</span>
                                            <input type="text" class="player-parent-input" placeholder="Parent Name" value="${p.parent || ''}" />
                                        </div>
                                    </div>
                                    <div class="new-player-actions">
                                        <button class="save-player-btn" onclick="handleSavePlayer('${tempId}')">Save</button>
                                        <button class="cancel-player-btn" onclick="handleCancelNewPlayer('${tempId}')">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="player-card-wrapper">
                        <div class="player-card ${isDeleted ? 'deleted' : ''}" data-player="${playerName}" data-index="${index}">
                            ${isDeleted ? '<div class="deleted-indicator">Deleted</div>' : ''}
                            <div class="player-card-front">
                                <div class="player-name">
                                    ${playerName}
                                    <div class="player-name-actions">
                                    ${p.jersey ? `<span class="jersey-number"><span class="jersey-icon"></span>${p.jersey}</span>` : ''}
                                        <button class="delete-player-btn" onclick="handleDeletePlayer('${playerName}')" title="Delete player"></button>
                                    </div>
                                </div>
                                <div class="player-details">
                                    ${p.parent ? `
                                        <div class="player-detail-item">
                                            <span class="player-detail-label">Parent</span>
                                            <span class="player-detail-value">${p.parent}</span>
                                        </div>
                                    ` : ''}
                                    <div class="player-detail-item">
                                        <span class="player-detail-label">Year</span>
                                        <span class="player-detail-value">${p.year || ''}</span>
                                    </div>
                                    ${Object.keys(goals).length > 0 ? `
                                        <div class="player-detail-item" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                            <span class="player-detail-label">Total Goals</span>
                                            <span class="player-detail-value" style="color: var(--accent-primary); font-weight: 600;">${getTotalGoals(goals)}</span>
                                        </div>
                                    ` : ''}
                                    ${Object.keys(goals).length > 0 ? `
                                        <div class="player-statistics" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                            <div class="stat-item">
                                                <span class="stat-label">Goals/Game</span>
                                                <span class="stat-value">${getGoalsPerGame(goals)}</span>
                                            </div>
                                            ${getGoalsThisMonth(goals) > 0 ? `
                                                <div class="stat-item">
                                                    <span class="stat-label">This Month</span>
                                                    <span class="stat-value">${getGoalsThisMonth(goals)}</span>
                                                </div>
                                            ` : ''}
                                            ${getRecentGoals(goals, 3).length > 0 ? `
                                                <div class="recent-goals">
                                                    <span class="stat-label">Recent:</span>
                                                    <div class="recent-goals-list">
                                                        ${getRecentGoals(goals, 3).map(recent => `
                                                            <span class="recent-goal-item">${formatGoalDate(recent.date)} (${recent.count})</span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${renderGoalsChart(goals)}
                                    ` : ''}
                                </div>
                            </div>
                            <div class="player-card-back">
                                <div class="notes-section">
                                    <div class="notes-label">Notes - ${playerName}</div>
                                    <textarea class="notes-textarea" id="notes-${index}" placeholder="Add notes about this player...">${getPlayerNotes(playerName)}</textarea>
                                    <button class="save-notes-btn" onclick="handleSaveNotes('${playerName}', ${index})">Save Notes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers for card flipping
            container.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't flip if clicking on input, button, textarea, or any element within them
                    // Check the entire event path to catch nested elements
                    const path = e.composedPath ? e.composedPath() : (e.path || []);
                    const clickedElement = e.target;
                    
                    const cardBack = this.querySelector('.player-card-back');
                    const cardFront = this.querySelector('.player-card-front');
                    const isCardFlipped = this.classList.contains('flipped');
                    const isClickingOnBack = cardBack && (cardBack === clickedElement || cardBack.contains(clickedElement));
                    const isClickingOnFront = cardFront && (cardFront === clickedElement || cardFront.contains(clickedElement));
                    
                    // If card is flipped:
                    // - Allow flip back when clicking on the front side
                    // - Allow flip back when clicking on empty space on the back (not on interactive elements)
                    // - Don't flip back when clicking on interactive elements on the back
                    if (isCardFlipped) {
                        if (isClickingOnFront) {
                            // Clicking on front when flipped - allow flip back, continue with normal flip logic
                            // Don't return here, let it proceed to flip
                        } else if (isClickingOnBack) {
                            // Check if clicking on interactive elements - if so, don't flip
                            const isClickingOnInteractive = clickedElement.closest('input, button, textarea') !== null;
                            if (isClickingOnInteractive) {
                                e.stopPropagation();
                                return;
                            }
                            // Clicking on empty space on the back - allow flip back
                            // Continue with normal flip logic
                        }
                    }
                    
                    // Early check for buttons - let onclick handlers work
                    if (clickedElement.tagName === 'BUTTON' || clickedElement.closest('button') !== null) {
                        // Don't stop propagation here - let the onclick handler fire
                        // Just return early to prevent card flip
                        return;
                    }
                    
                    // Check if any element in the path is an input, button, textarea
                    const isInteractiveElement = path.some(el => {
                        if (!el || !el.tagName) return false;
                        const tag = el.tagName.toUpperCase();
                        return tag === 'INPUT' || 
                               tag === 'BUTTON' || 
                               tag === 'TEXTAREA';
                    }) || clickedElement.tagName === 'INPUT' || 
                        clickedElement.tagName === 'BUTTON' || 
                        clickedElement.tagName === 'TEXTAREA' ||
                        clickedElement.closest('input, button, textarea') !== null;
                    
                    if (isInteractiveElement) {
                        e.stopPropagation();
                        // Only prevent default for inputs, not buttons (buttons need their onclick to work)
                        if (clickedElement.tagName !== 'BUTTON') {
                            e.preventDefault();
                        }
                        return;
                    }
                    
                    const wrapper = this.closest('.player-card-wrapper');
                    const isFlipping = !this.classList.contains('flipped');
                    
                    // Flip back any other flipped cards
                    if (isFlipping) {
                        container.querySelectorAll('.player-card.flipped').forEach(flippedCard => {
                            if (flippedCard !== this) {
                                flippedCard.classList.remove('flipped');
                                const flippedWrapper = flippedCard.closest('.player-card-wrapper');
                                if (flippedWrapper) {
                                    flippedWrapper.style.height = 'auto';
                                    flippedWrapper.style.overflow = 'visible';
                                }
                            }
                        });
                    }
                    
                    if (isFlipping) {
                        // Measure the back content height before flipping
                        const back = this.querySelector('.player-card-back');
                        const front = this.querySelector('.player-card-front');
                        const frontHeight = front.offsetHeight;
                        
                        // Temporarily make back visible and positioned to measure
                        const originalStyles = {
                            transform: back.style.transform,
                            position: back.style.position,
                            visibility: back.style.visibility,
                            opacity: back.style.opacity,
                            zIndex: back.style.zIndex
                        };
                        
                        back.style.transform = 'scale(1)';
                        back.style.position = 'relative';
                        back.style.visibility = 'visible';
                        back.style.opacity = '1';
                        back.style.zIndex = '2';
                        
                        // Force reflow
                        void back.offsetHeight;
                        
                        const backHeight = back.offsetHeight;
                        
                        // Restore original styles
                        Object.keys(originalStyles).forEach(key => {
                            back.style[key] = originalStyles[key] || '';
                        });
                        
                        // Set wrapper height to the larger of the two, with some padding
                        const targetHeight = Math.max(frontHeight, backHeight);
                        wrapper.style.height = targetHeight + 'px';
                        wrapper.style.overflow = 'visible';
                    } else {
                        // Reset to auto height when flipping back
                        wrapper.style.height = 'auto';
                        wrapper.style.overflow = 'visible';
                    }
                    
                    this.classList.toggle('flipped');
                    
                    // Set default date when card is flipped to show back
                    if (this.classList.contains('flipped')) {
                        const dateInput = this.querySelector('.goal-date-input');
                        if (dateInput && !dateInput.value) {
                            const today = new Date();
                            dateInput.value = today.toISOString().split('T')[0];
                        }
                    }
                });
            });
            
            // Set default date to today for all date inputs and prevent card flip on click
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            container.querySelectorAll('.notes-textarea').forEach(input => {
                // Prevent card flip when clicking on interactive elements
                // Use capture phase to stop propagation early
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }, true);
                input.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }, true);
                input.addEventListener('focus', function(e) {
                    e.stopPropagation();
                }, true);
                input.addEventListener('focusin', function(e) {
                    e.stopPropagation();
                }, true);
            });
            
            // Don't add event listeners to buttons - let onclick handlers work normally
            // The card's click handler will check for buttons and not flip
        }

        function handleSaveNotes(playerName, index) {
            const notesTextarea = document.getElementById(`notes-${index}`);
            const notes = notesTextarea.value.trim();
            savePlayerNotes(playerName, notes);
            
            // Show feedback
            const saveBtn = notesTextarea.nextElementSibling;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saved!';
            saveBtn.style.backgroundColor = 'var(--accent-secondary)';
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.backgroundColor = '';
            }, 1500);
        }

        async function savePlayersList() {
            if (!database) {
                return;
            }
            
            try {
                const playersRef = database.ref('playersList');
                const playersData = {};
                
                players.forEach(p => {
                    // Skip temporary/new players that haven't been saved yet
                    if (p._isNew || !p.player) {
                        return;
                    }
                    playersData[p.player] = {
                        player: p.player,
                        jersey: p.jersey || '',
                        parent: p.parent || '',
                        year: p.year || '',
                        returning: p.returning || '',
                        deleted: p.deleted || false
                    };
                });
                
                await playersRef.set(playersData);
                console.log('Players list saved to Firebase');
            } catch (e) {
                console.error('Failed to save players list to Firebase:', e);
            }
        }

        window.handleAddPlayer = function() {
            // Create a temporary new player with a unique ID
            const tempId = 'new-' + Date.now();
            const newPlayer = {
                player: '',
                jersey: '',
                parent: '',
                year: '',
                returning: 'Yes',
                deleted: false,
                _tempId: tempId,
                _isNew: true
            };
            
            // Add to players array
            players.push(newPlayer);
            
            // Re-render to show the empty card
            renderPlayers();
            
            // Scroll to the new player card
            setTimeout(() => {
                const newPlayerCard = document.querySelector(`.player-card[data-temp-id="${tempId}"]`);
                if (newPlayerCard) {
                    newPlayerCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Focus on the name input
                    const nameInput = newPlayerCard.querySelector('.player-name-input');
                    if (nameInput) {
                        nameInput.focus();
                    }
                }
            }, 100);
        };

        window.handleDeletePlayer = async function(playerName) {
            if (!confirm(`Are you sure you want to delete ${playerName}? They will be hidden but can be restored by showing deleted players.`)) {
                return;
            }
            
            const player = players.find(p => p.player === playerName);
            if (player) {
                player.deleted = true;
                await savePlayersList();
                renderPlayers();
            }
        };

        window.cleanupDeletedPlayers = async function() {
            const deletedPlayers = players.filter(p => p.deleted);
            const deletedCount = deletedPlayers.length;
            
            if (deletedCount === 0) {
                alert('No deleted players to clean up.');
                return;
            }
            
            if (!confirm(`Are you sure you want to permanently delete ${deletedCount} player(s)? This action cannot be undone.`)) {
                return;
            }
            
            // Get names of deleted players before removing them
            const deletedPlayerNames = deletedPlayers.map(p => p.player);
            
            // Remove deleted players from the array
            const originalLength = players.length;
            players = players.filter(p => !p.deleted);
            
            // Also remove their data from Firebase players node
            if (database) {
                try {
                    // Remove player data from Firebase
                    const playersRef = database.ref('players');
                    for (const playerName of deletedPlayerNames) {
                        await playersRef.child(encodeURIComponent(playerName)).remove();
                    }
                } catch (e) {
                    console.error('Failed to remove player data from Firebase:', e);
                }
            }
            
            // Save updated players list
            await savePlayersList();
            
            // Re-render
            renderPlayers();
            
            alert(`Successfully removed ${originalLength - players.length} deleted player(s).`);
        };

        window.handleAddPlayer = async function() {
            // Create a temporary new player with a unique ID
            const tempId = 'new-' + Date.now();
            const newPlayer = {
                player: '',
                jersey: '',
                parent: '',
                year: '',
                returning: 'Yes',
                deleted: false,
                _tempId: tempId,
                _isNew: true
            };
            
            // Add to players array
            players.push(newPlayer);
            
            // Re-render to show the empty card
            renderPlayers();
            
            // Scroll to the new player card
            setTimeout(() => {
                const newPlayerCard = document.querySelector(`.player-card[data-temp-id="${tempId}"]`);
                if (newPlayerCard) {
                    newPlayerCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Focus on the name input
                    const nameInput = newPlayerCard.querySelector('.player-name-input');
                    if (nameInput) {
                        nameInput.focus();
                    }
                }
            }, 100);
        };

        window.handleSavePlayer = async function(tempId) {
            const playerCard = document.querySelector(`.player-card[data-temp-id="${tempId}"]`);
            if (!playerCard) return;
            
            const nameInput = playerCard.querySelector('.player-name-input');
            const jerseyInput = playerCard.querySelector('.player-jersey-input');
            const parentInput = playerCard.querySelector('.player-parent-input');
            
            const playerName = nameInput ? nameInput.value.trim() : '';
            const jersey = jerseyInput ? jerseyInput.value.trim() : '';
            const parent = parentInput ? parentInput.value.trim() : '';
            
            if (!playerName) {
                alert('Please enter a player name.');
                if (nameInput) nameInput.focus();
                return;
            }
            
            // Check if player already exists (excluding the current temp player)
            const existingPlayer = players.find(p => p.player === playerName && !p._isNew);
            if (existingPlayer) {
                alert('A player with this name already exists.');
                if (nameInput) nameInput.focus();
                return;
            }
            
            // Find and update the player
            const playerIndex = players.findIndex(p => p._tempId === tempId);
            if (playerIndex !== -1) {
                const player = players[playerIndex];
                player.player = playerName;
                player.jersey = jersey;
                player.parent = parent;
                delete player._tempId;
                delete player._isNew;
            }
            
            // Save to Firebase
            await savePlayersList();
            
            // Re-render
            renderPlayers();
        };

        window.handleCancelNewPlayer = async function(tempId) {
            // Remove the temporary player from the array
            const playerIndex = players.findIndex(p => p._tempId === tempId);
            if (playerIndex !== -1) {
                players.splice(playerIndex, 1);
            }
            
            // Re-render
            renderPlayers();
        };

        function renderStats() {
            const container = document.getElementById('stats-container');
            
            if (players.length === 0) {
                container.innerHTML = `
                    <div class="stats-empty">
                        <p>No players found</p>
                        <small>Run <code style="background: var(--bg-section); padding: 4px 8px; border-radius: 4px;">migratePlayersToFirebase()</code> in the browser console to migrate players to Firebase.</small>
                    </div>
                `;
                return;
            }
            
            // Filter players (same logic as renderPlayers)
            const filteredPlayers = players.filter(p => {
                const returning = (p.returning || '').toString().toLowerCase().trim();
                const playerName = (p.player || '').toString().toLowerCase();
                return p.player && 
                       p.player !== '?' && 
                       !playerName.includes('child') &&
                       returning !== 'no';
            });
            
            // Get goals for each player and calculate totals
            const playerGoals = filteredPlayers.map(p => {
                const playerName = p.player || '';
                const goals = getPlayerGoals(playerName);
                const total = getTotalGoals(goals);
                return {
                    name: playerName,
                    total: total,
                    goals: goals
                };
            });
            
            // Filter out players with 0 goals and sort by total (descending)
            const playersWithGoals = playerGoals
                .filter(p => p.total > 0)
                .sort((a, b) => b.total - a.total);
            
            if (playersWithGoals.length === 0) {
                container.innerHTML = `
                    <div class="stats-empty">
                        <p>No goals recorded yet</p>
                        <small>Goals will appear here once players start scoring.</small>
                    </div>
                `;
                return;
            }
            
            // Find the longest player name to calculate proper spacing
            const longestName = playersWithGoals.reduce((longest, player) => 
                player.name.length > longest.length ? player.name : longest, '');
            const longestNameLength = longestName.length;
            const fontSize = 28; // Current font size for player labels
            // Calculate space needed: font size * number of characters + some padding
            // When rotated -90 degrees, the text width becomes the height
            const nameSpaceNeeded = (fontSize * longestNameLength * 0.6) + 20; // 0.6 is approximate character width ratio, +20 for padding (reduced)
            
            // Chart dimensions
            const chartWidth = 800;
            const chartHeight = 600; // Increased overall height for longer bars
            const padding = { 
                top: 40, 
                right: 40, 
                bottom: Math.max(200, nameSpaceNeeded + 10), // Dynamic bottom padding based on longest name, minimal buffer
                left: 80 // Increased left padding to prevent Goals text from being cut off
            };
            const barWidth = (chartWidth - padding.left - padding.right) / playersWithGoals.length - 10;
            const maxGoals = Math.max(...playersWithGoals.map(p => p.total), 1);
            const barHeight = chartHeight - padding.top - padding.bottom;
            
            let svg = `
                <div class="stats-chart-container">
                    <div class="stats-chart-title">Goals Scored by Player</div>
                    <div class="stats-chart-svg-container">
                        <svg viewBox="0 0 ${chartWidth} ${chartHeight}" preserveAspectRatio="xMidYMid meet">
                            <!-- Y-axis label -->
                            <text class="stats-chart-axis-label" 
                                  x="20" 
                                  y="${(padding.top + (barHeight / 2) )}" 
                                  transform="rotate(-90, 20, ${padding.top + (barHeight / 2)})"
                                  text-anchor="middle"
                                  dominant-baseline="middle">Goals</text>
                            
                            <!-- X-axis label -->
                            <text class="stats-chart-axis-label" 
                                  x="${chartWidth / 2}" 
                                  y="${(chartHeight - padding.bottom + 5) + 30}" 
                                  text-anchor="middle">Players</text>
                            
                            <!-- Y-axis grid lines and labels -->
                            ${Array.from({ length: 6 }, (_, i) => {
                                const value = Math.ceil(maxGoals / 5) * i;
                                const y = chartHeight - padding.bottom - (value / maxGoals) * barHeight;
                                return `
                                    <line x1="${padding.left}" 
                                          y1="${y}" 
                                          x2="${chartWidth - padding.right}" 
                                          y2="${y}" 
                                          stroke="var(--border-color)" 
                                          stroke-width="0.5" 
                                          opacity="0.3"/>
                                    <text class="stats-chart-axis-label" 
                                          x="${padding.left - 10}" 
                                          y="${y + 4}" 
                                          text-anchor="end">${value}</text>
                                `;
                            }).join('')}
                            
                            <!-- Bars -->
                            ${playersWithGoals.map((player, index) => {
                                const barHeightValue = (player.total / maxGoals) * barHeight;
                                const x = padding.left + index * (barWidth + 10);
                                const y = chartHeight - padding.bottom - barHeightValue;
                                
                                // Truncate player name if too long
                                const displayName = player.name.length > 12 
                                    ? player.name.substring(0, 10) + '...' 
                                    : player.name;
                                
                                return `
                                    <g>
                                        <rect class="stats-chart-bar" 
                                              x="${x}" 
                                              y="${y}" 
                                              width="${barWidth}" 
                                              height="${barHeightValue}"
                                              rx="4">
                                            <title>${player.name}: ${player.total} ${player.total === 1 ? 'goal' : 'goals'}</title>
                                        </rect>
                                        <text class="stats-chart-goal-value" 
                                              x="${x + barWidth / 2}" 
                                              y="${y - 8}">${player.total}</text>
                                        <text class="stats-chart-player-label" 
                                              x="${(x + barWidth / 2) - 40}" 
                                              y="${chartHeight - padding.bottom + (nameSpaceNeeded * 0.4)}"
                                              transform="rotate(-90, ${x + barWidth / 2}, ${chartHeight - padding.bottom + (nameSpaceNeeded * 0.4)})"
                                              text-anchor="middle">${player.name}</text>
                                    </g>
                                `;
                            }).join('')}
                        </svg>
                    </div>
                </div>
            `;
            
            // Generate attendance chart and captain history
            const attendanceChart = generateAttendanceChart(filteredPlayers);
            const captainHistory = generateCaptainHistoryChart();
            
            // Generate season stats
            const seasonStats = generateSeasonStats();
            
            container.innerHTML = seasonStats + attendanceChart + captainHistory + svg;
        }

        function generateSeasonStats() {
            // Calculate match statistics
            const matchSessions = sessions.filter(s => s.type === 'match' && !s.deleted);
            const completedMatches = matchSessions.filter(s => s.result);
            const wins = completedMatches.filter(s => s.result === 'win').length;
            const draws = completedMatches.filter(s => s.result === 'draw').length;
            const losses = completedMatches.filter(s => s.result === 'loss').length;
            const totalGoalsScored = completedMatches.reduce((sum, s) => sum + (parseInt(s.teamScore) || 0), 0);
            const totalGoalsConceded = completedMatches.reduce((sum, s) => sum + (parseInt(s.opponentScore) || 0), 0);
            const goalDiff = totalGoalsScored - totalGoalsConceded;

            return `
                <div class="season-stats-section" style="margin-bottom: 30px; padding: 20px; background: var(--bg-section); border-radius: 12px; border: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 15px 0; color: var(--accent); font-size: 18px; text-align: center;">Season Match Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px;">
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: bold; color: var(--accent);">${completedMatches.length}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Played</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: bold; color: #00ff64;">${wins}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Wins</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc800;">${draws}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Draws</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: bold; color: #ff3232;">${losses}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Losses</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: bold; color: var(--accent);">${totalGoalsScored}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Goals For</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: bold; color: var(--text-secondary);">${totalGoalsConceded}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Goals Against</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 15px; background: var(--bg-card); border-radius: 8px; grid-column: span 1;">
                            <div style="font-size: 28px; font-weight: bold; color: ${goalDiff > 0 ? '#00ff64' : goalDiff < 0 ? '#ff3232' : 'var(--accent)'};">${goalDiff > 0 ? '+' : ''}${goalDiff}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Goal Diff</div>
                        </div>
                    </div>
                    ${completedMatches.length > 0 ? `
                        <div style="margin-top: 15px; text-align: center; font-size: 18px; font-weight: bold; color: var(--text-primary);">
                            Record: ${wins}W - ${draws}D - ${losses}L
                        </div>
                    ` : `
                        <div style="margin-top: 15px; text-align: center; font-size: 14px; color: var(--text-secondary);">
                            No completed matches yet
                        </div>
                    `}
                </div>
            `;
        }

        function generateAttendanceChart(filteredPlayers) {
            // Get all matches
            const matches = sessions.filter(s => s.type === 'match' && !s.deleted);
            
            if (matches.length === 0) {
                return `
                    <div class="stats-chart-container">
                        <div class="stats-chart-title">Match Attendance</div>
                        <div class="stats-empty" style="padding: 40px;">
                            <p>No matches recorded yet</p>
                            <small>Match attendance will appear here once matches are added.</small>
                        </div>
                    </div>
                `;
            }
            
            // Calculate attendance stats for each player
            const playerAttendance = filteredPlayers.map(p => {
                const playerName = p.player || '';
                let attended = 0;
                let captainCount = 0;
                
                matches.forEach(match => {
                    if (match.attendance && match.attendance.includes(playerName)) {
                        attended++;
                    }
                    if (match.captain === playerName) {
                        captainCount++;
                    }
                });
                
                return {
                    name: playerName,
                    attended: attended,
                    captainCount: captainCount,
                    percentage: matches.length > 0 ? (attended / matches.length * 100).toFixed(0) : 0
                };
            }).filter(p => p.attended > 0).sort((a, b) => b.attended - a.attended);
            
            if (playerAttendance.length === 0) {
                return `
                    <div class="stats-chart-container">
                        <div class="stats-chart-title">Match Attendance</div>
                        <div class="stats-empty" style="padding: 40px;">
                            <p>No attendance recorded yet</p>
                            <small>Mark attendance in match cards to see stats here.</small>
                        </div>
                    </div>
                `;
            }
            
            // Find the longest player name to calculate proper spacing (same as goals chart)
            const longestName = playerAttendance.reduce((longest, player) => 
                player.name.length > longest.length ? player.name : longest, '');
            const longestNameLength = longestName.length;
            const fontSize = 28; // Same as goals chart
            const nameSpaceNeeded = (fontSize * longestNameLength * 0.6) + 20;
            
            // Chart dimensions - match goals chart exactly
            const chartWidth = 800;
            const chartHeight = 600;
            const padding = { 
                top: 40, 
                right: 40, 
                bottom: Math.max(200, nameSpaceNeeded + 10),
                left: 80
            };
            const barWidth = (chartWidth - padding.left - padding.right) / playerAttendance.length - 10;
            const maxAttended = Math.max(...playerAttendance.map(p => p.attended), 1);
            const barHeight = chartHeight - padding.top - padding.bottom;
            
            let svg = `
                <div class="stats-chart-container">
                    <div class="stats-chart-title">Match Attendance (${matches.length} ${matches.length === 1 ? 'match' : 'matches'})</div>
                    <div class="stats-chart-svg-container">
                        <svg viewBox="0 0 ${chartWidth} ${chartHeight}" preserveAspectRatio="xMidYMid meet">
                            <!-- Y-axis label -->
                            <text class="stats-chart-axis-label" 
                                  x="20" 
                                  y="${padding.top + (barHeight / 2)}" 
                                  transform="rotate(-90, 20, ${padding.top + (barHeight / 2)})"
                                  text-anchor="middle"
                                  dominant-baseline="middle">Matches Attended</text>
                            
                            <!-- X-axis label -->
                            <text class="stats-chart-axis-label" 
                                  x="${chartWidth / 2}" 
                                  y="${(chartHeight - padding.bottom + 5) + 30}" 
                                  text-anchor="middle">Players</text>
                            
                            <!-- Y-axis grid lines and labels -->
                            ${Array.from({ length: 6 }, (_, i) => {
                                const value = Math.ceil(maxAttended / 5) * i;
                                const y = chartHeight - padding.bottom - (value / maxAttended) * barHeight;
                                return `
                                    <line x1="${padding.left}" 
                                          y1="${y}" 
                                          x2="${chartWidth - padding.right}" 
                                          y2="${y}" 
                                          stroke="var(--border-color)" 
                                          stroke-width="0.5" 
                                          opacity="0.3"/>
                                    <text class="stats-chart-axis-label" 
                                          x="${padding.left - 10}" 
                                          y="${y + 4}" 
                                          text-anchor="end">${value}</text>
                                `;
                            }).join('')}
                            
                            <!-- Bars -->
                            ${playerAttendance.map((player, index) => {
                                const barHeightValue = (player.attended / maxAttended) * barHeight;
                                const x = padding.left + index * (barWidth + 10);
                                const y = chartHeight - padding.bottom - barHeightValue;
                                
                                return `
                                    <g>
                                        <rect class="stats-chart-bar" 
                                              x="${x}" 
                                              y="${y}" 
                                              width="${barWidth}" 
                                              height="${barHeightValue}"
                                              rx="4">
                                            <title>${player.name}: ${player.attended}/${matches.length} matches (${player.percentage}%)</title>
                                        </rect>
                                        <text class="stats-chart-goal-value" 
                                              x="${x + barWidth / 2}" 
                                              y="${y - 8}">${player.attended}</text>
                                        <text class="stats-chart-player-label" 
                                              x="${(x + barWidth / 2) - 40}" 
                                              y="${chartHeight - padding.bottom + (nameSpaceNeeded * 0.4)}"
                                              transform="rotate(-90, ${x + barWidth / 2}, ${chartHeight - padding.bottom + (nameSpaceNeeded * 0.4)})"
                                              text-anchor="middle">${player.name}</text>
                                    </g>
                                `;
                            }).join('')}
                        </svg>
                    </div>
                </div>
            `;
            
            return svg;
        }

        function generateCaptainHistoryChart() {
            // Get all matches that have a captain
            const matches = sessions.filter(s => s.type === 'match' && !s.deleted && s.captain);
            
            if (matches.length === 0) {
                return `
                    <div class="stats-chart-container">
                        <div class="stats-chart-title">Captain History</div>
                        <div class="stats-empty" style="padding: 40px;">
                            <p>No captains recorded yet</p>
                            <small>Assign captains in match cards to see history here.</small>
                        </div>
                    </div>
                `;
            }
            
            // Sort matches by date (most recent first for display)
            const sortedMatches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return `
                <div class="stats-chart-container">
                    <div class="stats-chart-title">Captain History (${matches.length} ${matches.length === 1 ? 'match' : 'matches'})</div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 12px; font-size: 13px; font-weight: 700; color: var(--text-secondary); padding-bottom: 12px; border-bottom: 2px solid var(--border-color); text-transform: uppercase; letter-spacing: 0.5px;">
                            <div style="text-align: center;">Date</div>
                            <div>Opponent</div>
                            <div style="display: flex; align-items: center; gap: 6px;"><span style="color: var(--accent-warm);"></span> Captain</div>
                        </div>
                        ${sortedMatches.map(match => {
                            const matchDate = new Date(match.date);
                            const formattedDate = matchDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                            return `
                                <div style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--text-primary); transition: all 0.2s ease;">
                                    <div style="text-align: center; color: var(--text-secondary); font-weight: 500;">${formattedDate}</div>
                                    <div style="font-weight: 500;">${match.opponent || 'Unknown'}</div>
                                    <div style="color: var(--accent-primary); font-weight: 600;">${match.captain}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Calendar functions
        window.changeMonth = function(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        };

        // This Week functions
        function renderThisWeek() {
            const container = document.getElementById('thisweek-container');
            
            // Get the start of this week (Monday)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday = 6 days from Monday
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - daysFromMonday);
            weekStart.setHours(0, 0, 0, 0);
            
            // Get the end of this week (Sunday)
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            // Find upcoming sessions this week (from today onwards)
            const upcomingSessions = sessions
                .filter(s => !s.deleted && !s.cancelled)
                .filter(s => {
                    const sessionDate = new Date(s.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    return sessionDate >= today && sessionDate >= weekStart && sessionDate <= weekEnd;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingSessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 10px;"></div>
                        <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">No Upcoming Events This Week</h3>
                        <p style="margin: 0;">Check back Monday for next week's schedule</p>
                    </div>
                `;
                return;
            }
            
            // Show only the next upcoming session
            const nextSession = upcomingSessions[0];
            const sessionDate = new Date(nextSession.date);
            
            // Get all active players
            const activePlayers = players.filter(p => {
                const returning = (p.returning || '').toString().toLowerCase().trim();
                const playerName = (p.player || '').toString().toLowerCase();
                return p.player && 
                       p.player !== '?' &&
                       !p.deleted &&
                       (returning === 'yes' || returning === '1' || returning === 'true') &&
                       !playerName.includes('child');
            }).sort((a, b) => a.player.localeCompare(b.player));
            
            const attendance = nextSession.attendance || [];
            
            const eventType = nextSession.type === 'match' ? 'Match' : 'Training';
            const eventTitle = nextSession.type === 'match' 
                ? `vs ${nextSession.opponent}` 
                : 'Training Session';
            
            const eventBadgeColor = nextSession.type === 'match' ? '#ff6b6b' : 'var(--accent)';
            
            container.innerHTML = `
                <div class="thisweek-card" style="max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div class="event-header" style="text-align: center; margin-bottom: 30px; padding: 20px; background: var(--bg-section); border-radius: 12px; border: 1px solid var(--border-color);">
                        <div class="event-type-badge" style="display: inline-block; padding: 6px 16px; background: ${eventBadgeColor}; color: var(--bg-primary); border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                            ${eventType}
                        </div>
                        <h2 style="margin: 10px 0; font-size: 28px; color: var(--text-primary);">${eventTitle}</h2>
                        <div style="font-size: 18px; color: var(--text-secondary); margin: 12px 0;">
                             ${formatDate(sessionDate)}
                        </div>
                        <div style="font-size: 20px; color: var(--accent); margin: 8px 0; font-weight: 600;">
                             ${nextSession.location || 'The Aura'}
                        </div>
                        <div style="font-size: 20px; color: var(--accent); margin: 8px 0; font-weight: 600;">
                             ${nextSession.time || '7:30 PM - 8:30 PM'}
                        </div>
                    </div>
                    
                    <div class="attendance-section" style="background: var(--bg-section); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 15px 0; color: var(--text-primary); text-align: center;">Player Attendance</h3>
                        <div class="attendance-summary" style="text-align: center; margin-bottom: 20px; font-size: 16px; color: var(--text-secondary);">
                            <span style="font-size: 24px; font-weight: bold; color: var(--accent);">${attendance.length}</span> of ${activePlayers.length} players attending
                        </div>
                        <div class="player-list">
                            ${activePlayers.map(player => {
                                const isAttending = attendance.includes(player.player);
                                return `
                                    <div class="player-attendance-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: var(--bg-card); border-radius: 8px; border: 1px solid ${isAttending ? 'var(--accent)' : 'var(--border-color)'}; transition: all 0.2s ease;">
                                        <span style="font-size: 16px; color: var(--text-primary); font-weight: ${isAttending ? '600' : '400'};">${player.player}</span>
                                        <label class="attendance-toggle" style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                                            <div class="toggle-switch" style="position: relative; width: 50px; height: 26px;">
                                                <input type="checkbox" 
                                                       ${isAttending ? 'checked' : ''}
                                                       onchange="handleThisWeekAttendance('${nextSession.id}', '${player.player.replace(/'/g, "\\'")}', this.checked)"
                                                       style="opacity: 0; width: 0; height: 0; position: absolute;">
                                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${isAttending ? 'var(--accent)' : 'var(--border-color)'}; transition: 0.3s; border-radius: 26px;">
                                                    <span style="position: absolute; content: ''; height: 20px; width: 20px; left: ${isAttending ? '27px' : '3px'}; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                                                </span>
                                            </div>
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        window.handleThisWeekAttendance = function(sessionId, playerName, isChecked) {
            const session = sessions.find(s => s.id == sessionId);
            if (!session) return;
            
            if (!session.attendance) session.attendance = [];
            
            if (isChecked) {
                if (!session.attendance.includes(playerName)) {
                    session.attendance.push(playerName);
                }
            } else {
                session.attendance = session.attendance.filter(name => name !== playerName);
                // Also clear captain if they're not attending
                if (session.captain === playerName) {
                    session.captain = '';
                }
                // Clear match goals if they had any
                if (session.matchGoals && session.matchGoals[playerName]) {
                    delete session.matchGoals[playerName];
                }
            }
            
            saveMatchData(sessionId);
            renderThisWeek();
        };

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const title = document.getElementById('calendarTitle');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            title.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            // Get days from previous month
            const prevMonthLastDay = new Date(currentCalendarYear, currentCalendarMonth, 0).getDate();
            const prevMonthDays = startDayOfWeek;
            
            // Get days for next month
            const totalCells = Math.ceil((daysInMonth + startDayOfWeek) / 7) * 7;
            const nextMonthDays = totalCells - daysInMonth - startDayOfWeek;
            
            // Build calendar HTML
            let html = '<div class="calendar">';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month days
            for (let i = prevMonthDays; i > 0; i--) {
                const day = prevMonthLastDay - i + 1;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                
                // Get events for this day
                const dayEvents = sessions.filter(s => {
                    if (s.deleted) return false;
                    const sessionDate = new Date(s.date);
                    return sessionDate.toDateString() === date.toDateString();
                }).sort((a, b) => {
                    // Sort by time if available
                    const timeA = a.time || '';
                    const timeB = b.time || '';
                    return timeA.localeCompare(timeB);
                });
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                html += `<div class="calendar-events">`;
                
                dayEvents.forEach(event => {
                    const type = event.type || 'training';
                    const cancelled = event.cancelled ? 'cancelled' : '';
                    let label = '';
                    if (type === 'match') {
                        label = event.opponent || 'Match';
                    } else {
                        label = event.time || 'Training';
                    }
                    html += `<div class="calendar-event ${type} ${cancelled}" onclick="scrollToSession(${event.id})" title="${label}">${label}</div>`;
                });
                
                html += `</div></div>`;
            }
            
            // Next month days
            for (let day = 1; day <= nextMonthDays; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        window.scrollToSession = function(sessionId) {
            // Switch to schedule tab
            const scheduleButton = document.querySelector('.tab-button[data-tab="schedule"]');
            if (scheduleButton) {
                scheduleButton.click();
            }
            
            // Scroll to the session
            setTimeout(() => {
                const sessionCard = document.querySelector(`.session-card[data-session="${sessionId}"]`);
                if (sessionCard) {
                    sessionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Briefly highlight the card
                    sessionCard.style.boxShadow = '0 0 30px rgba(0, 212, 170, 0.5)';
                    setTimeout(() => {
                        sessionCard.style.boxShadow = '';
                    }, 2000);
                }
            }, 300);
        };

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const tabs = document.querySelector('.tabs');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    switchToTab(targetTab);
                });
            });
            
            // Setup players controls on initial load if players tab is active
            if (document.getElementById('players-tab').classList.contains('active')) {
                setupPlayersControls();
            }
        }
        
        function setupPlayersControls() {
            const showDeletedToggle = document.getElementById('showDeletedPlayers');
            if (showDeletedToggle) {
                // Remove existing listeners to avoid duplicates
                const newToggle = showDeletedToggle.cloneNode(true);
                showDeletedToggle.parentNode.replaceChild(newToggle, showDeletedToggle);
                
                newToggle.addEventListener('change', () => {
                    showDeletedPlayers = newToggle.checked;
                    renderPlayers();
                });
            }
            
            // Tabs are now fixed at the top via CSS, no JavaScript manipulation needed
        }

        // Migration function to add sessions structure to Firebase
        window.migrateSessionsToFirebase = async function() {
            if (!database) {
                console.error('Firebase not initialized - cannot migrate');
                return;
            }

            const sessionsData = [
                { id: 1, date: new Date(2026, 1, 3), desc: '', warmup: '', drills: '', game: '' },
                { id: 2, date: new Date(2026, 1, 10), desc: '', warmup: '', drills: '', game: '' },
                { id: 3, date: new Date(2026, 1, 17), desc: '', warmup: '', drills: '', game: '' },
                { id: 4, date: new Date(2026, 1, 24), desc: '', warmup: '', drills: '', game: '' },
                { id: 5, date: new Date(2026, 2, 3), desc: '', warmup: '', drills: '', game: '' },
                { id: 6, date: new Date(2026, 2, 10), desc: '', warmup: '', drills: '', game: '' },
                { id: 7, date: new Date(2026, 2, 17), cancelled: true, cancelReason: "St. Patrick's Day " },
                { id: 8, date: new Date(2026, 2, 24), desc: '', warmup: '', drills: '', game: '' },
            ];
            
            try {
                console.log('Starting sessions structure migration to Firebase...');
                
                // Convert array to object with id as key, and convert dates to ISO strings
                const sessionsObject = {};
                sessionsData.forEach(session => {
                    sessionsObject[session.id] = {
                        id: session.id,
                        date: session.date.toISOString(),
                        cancelled: session.cancelled || false,
                        cancelReason: session.cancelReason || ''
                    };
                });
                
                // Save to Firebase
                const sessionsListRef = database.ref('sessionsList');
                await sessionsListRef.set(sessionsObject);
                
                console.log('Sessions structure migration completed successfully!');
                console.log('Migrated sessions:', sessionsData.length);
                
                alert('Sessions structure migration completed! Data has been transferred to Firebase.');
                
            } catch (error) {
                console.error('Sessions migration failed:', error);
                alert('Sessions migration failed: ' + error.message);
            }
        };

        // Migration function to add players to Firebase
        window.migratePlayersToFirebase = async function() {
            if (!database) {
                console.error('Firebase not initialized - cannot migrate');
                return;
            }

            const playersData = [
                { parent: 'Ian Strain', phone: '+353 86 877 4663', player: 'Chloe Strain', year: '2014', jersey: '#', returning: 'Yes' },
                { parent: 'Sinad Giles', phone: '+353 86 343 2733', player: 'Aoibhin Giles', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Mark McBride/Caroline McBride', phone: '+353 85 123 4231/+353 87 770 1206', player: 'Sarah McBride', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Steven Gallagher/Deborah Callaghan', phone: '+353 85 712 2232', player: 'Eimear Gallagher', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Aisling', phone: '+353 86 053 5867', player: 'Leah McClafferty', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Annemarie McBride/Martin Kennedy', phone: '+353 87 963 4431/+353 86 400 3128', player: 'Sinad Kennedy', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Aoife', phone: '+353 87 940 3055', player: 'Lauren Diver', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Brd O\' Donnell', phone: '+353 86 196 7547', player: '?', year: '', jersey: '#', returning: 'No' },
                { parent: 'Ciarn N Fearraigh/Sile Kelly', phone: '+353 87 984 9564/+353 86 201 8876', player: 'Aoibh N Fhearraigh', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Clona', phone: '+353 86 395 6987', player: 'Zoe and Molly', year: '', jersey: '#', returning: 'No' },
                { parent: 'Fawzi', phone: '+353 87 263 2160', player: 'child has left', year: '', jersey: '#', returning: 'No' },
                { parent: 'Jenny Duncan', phone: '+353 86 350 4064', player: 'Chelsea', year: '', jersey: '#', returning: 'No' },
                { parent: 'Josie', phone: '+353 83 066 8724', player: 'Ella Toland', year: '', jersey: '#', returning: 'No' },
                { parent: 'Laela Curran', phone: '+353 86 170 2485', player: 'Seva Curran', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Louise/Justin Sterritt', phone: '+353 86 343 8505/+353 86 062 1717', player: 'Arianne Sherritt', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Nicola', phone: '+353 86 086 0444', player: '?', year: '', jersey: '#', returning: 'No' },
                { parent: 'Orlaith/Niall', phone: '+353 86 805 0155/+353 83 427 4881', player: 'Faela Kavannagh', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Paddy Carr', phone: '+353 87 918 1128', player: 'Aoife Carr', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Paddy McTeague', phone: '+353 87 640 9560', player: 'Aisling McTeague', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Raymond Carey', phone: '+353 86 216 9856', player: 'Clara Carey', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Sumalatha Aka', phone: '+353 85 178 9502', player: 'Poshita', year: '', jersey: '#', returning: 'Yes' },
                { parent: 'Wego', phone: '+353 87 372 7683', player: 'child left club', year: '', jersey: '#', returning: 'No' },
                { parent: 'Martina', phone: '+353 87 958 7465', player: 'Rebecca', year: '', jersey: '#', returning: 'No' },
                { parent: 'Laura Muhandiramge', phone: '+353 87 396 4780', player: 'Eliana', year: '', jersey: '#', returning: 'Yes' }
            ];
            
            try {
                console.log('Starting players migration to Firebase...');
                
                // Convert array to object with index keys for Firebase
                const playersObject = {};
                playersData.forEach((player, index) => {
                    playersObject[index] = player;
                });
                
                // Save to Firebase
                const playersRef = database.ref('playersList');
                await playersRef.set(playersObject);
                
                console.log('Players migration completed successfully!');
                console.log('Migrated players:', playersData.length);
                
                alert('Players migration completed! Data has been transferred to Firebase.');
                
            } catch (error) {
                console.error('Players migration failed:', error);
                alert('Players migration failed: ' + error.message);
            }
        };

        function toggleMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const menuOverlay = document.getElementById('menuOverlay');
            const menuDrawer = document.getElementById('menuDrawer');
            
            menuToggle.classList.toggle('active');
            menuOverlay.classList.toggle('active');
            menuDrawer.classList.toggle('active');
            
            if (menuDrawer.classList.contains('active')) {
                updateMenuContent();
            }
        }

        function closeMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const menuOverlay = document.getElementById('menuOverlay');
            const menuDrawer = document.getElementById('menuDrawer');
            
            menuToggle.classList.remove('active');
            menuOverlay.classList.remove('active');
            menuDrawer.classList.remove('active');
        }

        window.switchToTab = function(tabName) {
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            // Update buttons only if the tab exists as a button
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Render specific content
            if (tabName === 'schedule') {
                renderSessions();
                scrollToClosestSession();
            } else if (tabName === 'calendar') {
                currentCalendarMonth = new Date().getMonth();
                currentCalendarYear = new Date().getFullYear();
                renderCalendar();
            } else if (tabName === 'players') {
                renderPlayers();
            } else if (tabName === 'stats') {
                renderStats();
            } else if (tabName === 'thisweek') {
                renderThisWeek();
            }
            updateMenuContent(); // Refresh menu options based on new active tab
        };

        function updateMenuContent() {
            const menuContent = document.getElementById('menuContent');
            const menuTitle = document.getElementById('menuTitle');
            
            // Determine which tab content is active
            let activeTab = 'schedule';
            const activeContent = document.querySelector('.tab-content.active');
            if (activeContent) {
                activeTab = activeContent.id.replace('-tab', '');
            }
            
            let html = '';
            
            if (activeTab === 'schedule') {
                menuTitle.textContent = 'Schedule Options';
                html = `
                    <div class="menu-section">
                        <div class="edit-toggle">
                            <label for="editMode">Edit Mode</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="editMode">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    <div class="menu-section">
                        <div class="menu-section-title">Filter</div>
                        <div class="view-toggles">
                            <div class="view-toggle">
                                <label for="showTraining">Show Training</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="showTraining">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                            <div class="view-toggle">
                                <label for="showMatches">Show Matches</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="showMatches">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="menu-section">
                        <div class="menu-section-title">View Options</div>
                        <div class="view-toggles">
                            <div class="view-toggle">
                                <label for="showPastSessions">Show Past Sessions</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="showPastSessions">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                            <div class="view-toggle">
                                <label for="showDeletedSessions">Show Deleted Sessions</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="showDeletedSessions">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="menu-section">
                        <div class="menu-section-title">Actions</div>
                        <button class="cleanup-btn" onclick="cleanupDeletedSessions(); closeMenu();" title="Permanently remove all deleted sessions">
                             Clean Up Deleted
                        </button>
                        <button class="add-session-btn-bottom" onclick="handleAddSession(); closeMenu();" title="Add a new session">
                             New Session
                        </button>
                    </div>
                    <div class="menu-section">
                        <button class="add-player-btn" onclick="switchToTab('thisweek'); closeMenu();" title="View this week's event">
                             This Week
                        </button>
                    </div>
                    <div class="menu-section">
                        <button class="add-player-btn" onclick="switchToTab('stats'); closeMenu();" title="View goal statistics">
                             View Stats
                        </button>
                    </div>
                `;
            } else if (activeTab === 'calendar') {
                menuTitle.textContent = 'Calendar Options';
                html = `
                    <div class="menu-section">
                        <button class="add-player-btn" onclick="switchToTab('thisweek'); closeMenu();" title="View this week's event">
                             This Week
                        </button>
                    </div>
                    <div class="menu-section">
                        <button class="add-player-btn" onclick="switchToTab('stats'); closeMenu();" title="View goal statistics">
                             View Stats
                        </button>
                    </div>
                `;
            } else if (activeTab === 'players') {
                menuTitle.textContent = 'Player Options';
                html = `
                    <div class="menu-section">
                        <div class="menu-section-title">View Options</div>
                        <div class="view-toggles">
                            <div class="view-toggle">
                                <label for="showDeletedPlayers">Show Deleted Players</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="showDeletedPlayers">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="menu-section">
                        <div class="menu-section-title">Actions</div>
                        <button class="cleanup-btn" onclick="cleanupDeletedPlayers(); closeMenu();" title="Permanently remove all deleted players">
                             Clean Up Deleted
                        </button>
                        <button class="add-player-btn" onclick="handleAddPlayer(); closeMenu();" title="Add a new player">
                             Add Player
                        </button>
                    </div>
                    <div class="menu-section">
                        <button class="add-player-btn" onclick="switchToTab('thisweek'); closeMenu();" title="View this week's event">
                             This Week
                        </button>
                    </div>
                    <div class="menu-section">
                        <button class="add-player-btn" onclick="switchToTab('stats'); closeMenu();" title="View goal statistics">
                             View Stats
                        </button>
                    </div>
                `;
            } else if (activeTab === 'stats') {
                menuTitle.textContent = 'Statistics';
                html = `
                    <div class="menu-section">
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                            Viewing statistics for all players including goals and attendance.
                        </p>
                    </div>
                `;
            } else {
                menuTitle.textContent = 'Options';
                html = `
                    <div class="menu-section">
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                            No options available.
                        </p>
                    </div>
                `;
            }
            
            menuContent.innerHTML = html;
            
            // Restore toggle states
            if (activeTab === 'schedule') {
                const editModeToggle = document.getElementById('editMode');
                const showPastToggle = document.getElementById('showPastSessions');
                const showDeletedToggle = document.getElementById('showDeletedSessions');
                const showTrainingToggle = document.getElementById('showTraining');
                const showMatchesToggle = document.getElementById('showMatches');
                if (editModeToggle) editModeToggle.checked = editMode;
                if (showPastToggle) showPastToggle.checked = showPastSessions;
                if (showDeletedToggle) showDeletedToggle.checked = showDeletedSessions;
                if (showTrainingToggle) showTrainingToggle.checked = showTraining;
                if (showMatchesToggle) showMatchesToggle.checked = showMatches;
                setupEditMode();
                setupFilterToggles();
            } else if (activeTab === 'players') {
                const showDeletedToggle = document.getElementById('showDeletedPlayers');
                if (showDeletedToggle) showDeletedToggle.checked = showDeletedPlayers;
                setupPlayersControls();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Load players first so they're available when rendering match cards
            await loadPlayersFromFirebase();
            await loadGoalsFromFirebase();
            
            // Load sessions structure first, then session content
            await loadSessionsFromFirebase();
            await loadData();
            renderSessions();
            setupEditMode();
            scrollToClosestSession();
            setupTabs();
            renderPlayers();
            setupPlayersControls();
            
            // Update menu when tabs change
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    setTimeout(updateMenuContent, 100);
                });
            });
        });
    </script>
</body>
</html>
